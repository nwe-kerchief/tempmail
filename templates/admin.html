
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - TempMail</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em'   font-size='90'>üõ°Ô∏è</text></svg>">
<style>
body {
font-family: 'Inter', sans-serif;
background: linear-gradient(135deg, #1e3a8a 0%, #7e22ce 100%);
min-height: 100vh;
}
.glass-effect {
background: rgba(255, 255, 255, 0.15);
backdrop-filter: blur(12px);
border: 1px solid rgba(255, 255, 255, 0.2);
}
.address-item {
transition: all 0.2s ease;
cursor: pointer;
}
.address-item:hover {
background: rgba(255, 255, 255, 0.2);
transform: translateY(-1px);
}
.fade-in {
animation: fadeIn 0.5s ease-in;
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}
#login-screen {
display: flex;
justify-content: center;
align-items: center;
min-height: 100vh;
}
.login-box {
background: rgba(255, 255, 255, 0.15);
backdrop-filter: blur(12px);
border: 1px solid rgba(255, 255, 255, 0.2);
padding: 40px;
border-radius: 20px;
text-align: center;
max-width: 400px;
width: 100%;
}
.login-box input {
width: 100%;
padding: 15px;
margin-bottom: 20px;
background: rgba(0, 0, 0, 0.3);
border: 2px solid rgba(255, 255, 255, 0.2);
border-radius: 10px;
color: white;
font-size: 16px;
}
.login-box input::placeholder {
color: rgba(255, 255, 255, 0.5);
}
.login-box button {
width: 100%;
padding: 15px;
background: linear-gradient(135deg, #a855f7, #ec4899);
border: none;
border-radius: 10px;
color: white;
font-size: 16px;
font-weight: bold;
cursor: pointer;
transition: all 0.3s ease;
}
.login-box button:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(168, 85, 247, 0.4);
}
.error {
color: #fca5a5;
margin-top: 10px;
font-size: 14px;
}

/* Custom Modal */
.modal-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.7);
display: flex;
align-items: center;
justify-content: center;
z-index: 1000;
backdrop-filter: blur(5px);
}
.modal-content {
background: linear-gradient(135deg, #1e293b 0%, #374151 100%);
border-radius: 16px;
padding: 2rem;
max-width: 400px;
width: 90%;
border: 1px solid rgba(255, 255, 255, 0.1);
box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
}
.modal-buttons {
display: flex;
gap: 12px;
margin-top: 1.5rem;
}
.modal-btn {
flex: 1;
padding: 12px 20px;
border-radius: 10px;
font-weight: 600;
transition: all 0.2s ease;
border: none;
cursor: pointer;
}
.modal-btn-confirm {
background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
color: white;
}
.modal-btn-confirm:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
}
.modal-btn-cancel {
background: rgba(255, 255, 255, 0.1);
color: white;
border: 1px solid rgba(255, 255, 255, 0.2);
}
.modal-btn-cancel:hover {
background: rgba(255, 255, 255, 0.2);
transform: translateY(-2px);
}

/* Scrollbar styling */
.custom-scrollbar::-webkit-scrollbar {
width: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 3px;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
background: rgba(255, 255, 255, 0.3);
border-radius: 3px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
background: rgba(255, 255, 255, 0.5);
}

/* Responsive Design */
@media (max-width: 768px) {
.mobile-stack { flex-direction: column; }
.mobile-full { width: 100%; }
.mobile-text-center { text-align: center; }
.mobile-inbox-container { flex-direction: column; height: auto; }
.mobile-inbox-list { height: 300px; max-height: 300px; }
.mobile-email-content { height: 400px; max-height: 400px; }
.login-box { padding: 20px; margin: 10px; }
}

@media (min-width: 768px) {
#email-content-container {
height: 550px;
max-height: 550px;
}
#email-body {
height: 350px;
max-height: 350px;
}
}

/* iFrame Email System */
.email-iframe-wrapper {
    width: 100%;
    height: 400px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    overflow: hidden;
    background: #111827; /* Dark background for wrapper */
}

.sandboxed-iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: #111827; /* Dark iframe background */
}

.email-fallback {
    background: rgba(0, 0, 0, 0.6); /* Much darker */
    padding: 20px;
    border-radius: 12px;
    color: #e5e7eb;
    line-height: 1.6;
    height: 100%;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Better text contrast */
.email-fallback p {
    margin-bottom: 1rem;
    color: #f3f4f6; /* Lighter text for better contrast */
}

.email-fallback a {
    color: #93c5fd; /* Lighter blue for better visibility */
    text-decoration: underline;
}

.email-fallback a:hover {
    color: #bfdbfe;
}



.border-red-500 {
border-color: #ef4444 !important;
}
.bg-blue-600 {
background-color: #2563eb;
}
.bg-blue-600:hover {
background-color: #1d4ed8;
}

.bg-red-500 {
    background-color: #ef4444 !important;
}

.session-item {
transition: all 0.2s ease;
cursor: pointer;
}
.session-item:hover {
background: rgba(255, 255, 255, 0.1);
transform: translateY(-1px);
}
/* Search and highlight styles */
#email-search {
    transition: all 0.3s ease;
}

#email-search:focus {
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
}

.mark {
    background-color: #fef3c7;
    color: #92400e;
    padding: 0 2px;
    border-radius: 2px;
}

/* Blacklisted item styling */
.blacklisted-item {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(185, 28, 28, 0.2) 100%);
    border-left: 4px solid #ef4444;
}

/* Smooth transitions for search results */
.address-item {
    transition: all 0.2s ease-in-out;
}

/* Enhanced dark mode for email content */
.email-original {
    background: #1f2937 !important;
    color: #e5e7eb !important;
    padding: 20px;
    border-radius: 8px;
    font-family: inherit;
    line-height: 1.6;
}

.email-original h1, 
.email-original h2, 
.email-original h3 {
    color: #f9fafb !important;
    margin-bottom: 1rem;
}

.email-original p {
    color: #e5e7eb !important;
    margin-bottom: 1rem;
}

.email-original a {
    color: #60a5fa !important;
    text-decoration: underline;
}

.email-original code {
    background: rgba(255, 255, 255, 0.1);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
    color: #e5e7eb;
}

/* Better button hover effects */
button:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}

/* Improved modal styling */
.modal-content {
    background: linear-gradient(135deg, #1e293b 0%, #374151 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
}
</style>
</head>
<body class="text-gray-100 min-h-screen p-4">

<!-- Custom Modal Structure -->
<div id="custom-modal" class="modal-overlay hidden">
<div class="modal-content">
<div class="text-center mb-4">
<i class="fas fa-exclamation-triangle text-3xl text-yellow-400 mb-3"></i>
<h3 class="text-xl font-bold text-white mb-2" id="modal-title">Confirm Action</h3>
<p class="text-gray-300" id="modal-message">Are you sure you want to proceed?</p>
</div>
<div class="modal-buttons">
<button id="modal-cancel" class="modal-btn modal-btn-cancel">Cancel</button>
<button id="modal-confirm" class="modal-btn modal-btn-confirm">Confirm</button>
</div>
</div>
</div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
<div class="login-box">
<i class="fas fa-shield-alt text-5xl text-white mb-4"></i>
<h1 class="text-3xl font-bold text-white mb-2">Admin Panel</h1>
<p class="text-gray-300 mb-6">TempMail System Administration</p>
<input type="password" id="admin-password" placeholder="Enter admin password" />
<button id="admin-login-btn">
<i class="fas fa-sign-in-alt mr-2"></i>Login
</button>
<p id="admin-login-error" class="error" style="display:none;">‚ùå Invalid password</p>
</div>
</div>

<!-- ADMIN DASHBOARD (Hidden until logged in) -->
<div id="admin-dashboard" style="display:none;">
    <div class="w-full max-w-7xl mx-auto fade-in">
        <header class="text-center mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <div class="flex items-center mobile-text-center">
                    <i class="fas fa-shield-alt text-3xl text-white mr-3"></i>
                    <h1 class="text-2xl md:text-4xl font-bold text-white">Admin Dashboard</h1>
                </div>
                <div class="flex gap-2 flex-wrap justify-center">
                    <a href="/" class="bg-blue-600 hover:bg-blue-700 text-white px-3 md:px-4 py-2 rounded-lg transition-all transform hover:scale-105 text-sm md:text-base">
                        <i class="fas fa-home mr-2"></i>Main Site
                    </a>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white px-3 md:px-4 py-2 rounded-lg transition-all transform hover:scale-105 text-sm md:text-base">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
            <p class="text-gray-300 text-sm md:text-base">Monitor and manage all temporary email addresses</p>
        </header>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="glass-effect rounded-xl p-4 md:p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Total Emails</p>
                        <p id="stat-emails" class="text-2xl md:text-3xl font-bold text-white">0</p>
                    </div>
                    <i class="fas fa-envelope text-3xl md:text-4xl text-blue-400"></i>
                </div>
            </div>
            <div class="glass-effect rounded-xl p-4 md:p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Email Addresses</p>
                        <p id="stat-addresses" class="text-2xl md:text-3xl font-bold text-white">0</p>
                    </div>
                    <i class="fas fa-users text-3xl md:text-4xl text-green-400"></i>
                </div>
            </div>
            <div class="glass-effect rounded-xl p-4 md:p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Last 24 Hours</p>
                        <p id="stat-recent" class="text-2xl md:text-3xl font-bold text-white">0</p>
                    </div>
                    <i class="fas fa-clock text-3xl md:text-4xl text-purple-400"></i>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 mobile-stack">
            <div class="glass-effect rounded-xl p-4 md:p-6 fade-in mobile-full">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                    <h2 class="text-lg md:text-xl font-bold text-white">
                        <i class="fas fa-list mr-2"></i>Email Addresses
                    </h2>
                    <div class="flex gap-2">
                        <!-- Search Input -->
                        <div class="relative">
                            <input type="text" id="email-search" placeholder="Search username..." 
                                class="bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none w-48 text-sm pl-10">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <button onclick="clearSearch()" id="clear-search-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg transition-all text-sm hidden">
                            <i class="fas fa-times mr-1"></i> Clear
                        </button>
                        <button onclick="loadAddresses()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition-all transform hover:scale-105 text-sm">
                            <i class="fas fa-sync-alt mr-1"></i> Refresh
                        </button>
                    </div>
                </div>
                <div id="address-list" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar mobile-inbox-list">
                    <p class="text-gray-400 text-center py-8">Loading addresses...</p>
                </div>
            </div>

            <!-- Email Details -->
            <div class="glass-effect rounded-xl p-4 md:p-6 fade-in mobile-full">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                    <h2 class="text-lg md:text-xl font-bold text-white">
                        <i class="fas fa-envelope-open mr-2"></i>Emails for: 
                        <span id="selected-address" class="text-blue-400 text-sm md:text-base">None selected</span>
                    </h2>
                    <div id="email-count-badge" class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs md:text-sm font-medium hidden">
                        0 emails
                    </div>
                </div>
                
                <!-- Single Container for List and Content View -->
                <div id="admin-inbox-container" class="w-full bg-gray-900 rounded-xl p-3 overflow-y-auto" style="height: 500px;">
                    
                    <!-- Email List View -->
                    <div id="admin-email-list-view" class="h-full">
                        <div id="email-details" class="space-y-2 h-full overflow-y-auto custom-scrollbar">
                            <p class="text-gray-400 text-center py-8">Select an address to view emails</p>
                        </div>
                    </div>
                    
                    <!-- Email Content View (Hidden by default) -->
                    <div id="admin-email-content-view" class="hidden h-full flex flex-col">
                        <!-- Back Button -->
                        <button id="admin-back-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg mb-4 transition-all text-sm flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i>Back to List
                        </button>
                        
                        <!-- Email Header -->
                        <div class="border-b border-gray-700 pb-4 mb-4">
                            <h2 id="admin-email-subject" class="text-lg md:text-xl font-bold text-white mb-2 break-words"></h2>
                            <div class="flex items-center text-xs md:text-sm text-gray-300 mb-2">
                                <strong class="mr-2 text-white font-semibold flex items-center">
                                    <i class="fas fa-user mr-2"></i>From:
                                </strong>
                                <span id="admin-email-from" class="font-mono font-medium break-all"></span>
                            </div>
                            <span id="admin-email-date" class="text-xs text-gray-400"></span>
                        </div>

                        <!-- Email Body - iFrame Version -->
                        <div class="email-iframe-wrapper flex-1">
                            <iframe id="admin-email-iframe" class="sandboxed-iframe"
                                    sandbox="allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe>
                            <div id="admin-email-fallback" class="email-fallback hidden"></div>
                        </div>
                                                

                        <!-- Delete Button -->
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <button id="admin-delete-email-btn" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-all text-sm">
                                <i class="fas fa-trash mr-2"></i>Delete Email
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Sessions Section -->
        <div class="glass-effect rounded-xl p-4 md:p-6 fade-in mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                <h2 class="text-lg md:text-xl font-bold text-white">
                    <i class="fas fa-play-circle mr-2"></i>Active Sessions
                </h2>
                <div class="flex gap-2">
                    <button onclick="loadActiveSessions()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-all transform hover:scale-105 text-sm">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
            </div>
            <div id="active-sessions" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                <p class="text-gray-400 text-center py-8">Loading active sessions...</p>
            </div>
        </div>



        <!-- Blacklist Management Section -->
        <div class="glass-effect rounded-xl p-4 md:p-6 fade-in">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                <h2 class="text-lg md:text-xl font-bold text-white">
                    <i class="fas fa-ban mr-2"></i>Blacklisted Usernames
                </h2>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                    <input type="text" id="new-blacklist-username" placeholder="Enter username to blacklist" 
                           class="bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none w-full sm:w-48 text-sm">
                    <button onclick="addToBlacklist()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-all transform hover:scale-105 whitespace-nowrap text-sm">
                        <i class="fas fa-plus mr-1"></i> Add to Blacklist
                    </button>
                </div>
            </div>
            <div id="blacklist-list" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                <p class="text-gray-400 text-center py-8">Loading blacklist...</p>
            </div>
        </div>

        <!-- Updated Access Code Generation Form -->
        <div class="bg-gray-800 rounded-lg p-4 mb-4">
            <h3 class="text-white font-semibold mb-3">Generate New Access Code</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-3 mb-3">
                <input type="text" id="generate-code-email" placeholder="Username" 
                    class="bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none text-sm">
                
                <select id="generate-code-domain" class="bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none text-sm">
                    <option value="">Select domain</option>
                </select>

                <input type="text" id="generate-code-custom" placeholder="Custom code (optional)" 
                    class="bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none text-sm uppercase font-mono"
                    maxlength="12">
                
                <input type="text" id="generate-code-description" placeholder="Description (optional)" 
                    class="bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none text-sm col-span-2"
                    maxlength="100">
                
                <select id="generate-code-duration" class="bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none text-sm">
                    <option value="60">1 Hour</option>
                    <option value="1440" selected>24 Hours</option>
                    <option value="10080">7 Days</option>
                    <option value="43200">30 Days</option>
                </select>
                
                <input type="number" id="generate-code-uses" placeholder="Max uses" 
                    class="bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none text-sm"
                    min="1" max="1000" value="1">
            </div>
            <button onclick="generateAccessCode()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-all transform hover:scale-105 text-sm w-full">
                <i class="fas fa-plus mr-1"></i> Generate Access Code
            </button>
        </div>
        <div id="access-codes-list" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                <p class="text-gray-400 text-center py-8">Loading access codes...</p>
            </div>
        </div>

<script>
var API_URL = window.location.origin;
var selectedAddress = null;
var autoRefreshInterval = null;
var DOMAIN = 'aungmyomyatzaw.online';
var currentViewingEmail = null;

// Stop refresh loop - check if we're already trying to login
let loginAttemptInProgress = false;

document.addEventListener('DOMContentLoaded', function() {
    console.log('üõë Admin panel loaded - NO AUTO-REFRESH');

        // Clear any client-side session indicators
    localStorage.removeItem('adminAuthenticated');
    sessionStorage.removeItem('adminAuthenticated');
    
    // Set up ALL event listeners here
        const randomButtons = document.querySelectorAll('button[id*="random"], button[onclick*="random"], button[class*="random"]');
    randomButtons.forEach(btn => {
        console.log('Removing random button:', btn);
        btn.remove();
    });
    
    // Also remove any random generator inputs
    const randomInputs = document.querySelectorAll('input[placeholder*="random"], input[id*="random"]');
    randomInputs.forEach(input => input.remove());
    
    // Prevent multiple clicks on generate button
    const generateBtn = document.querySelector('button[onclick="generateAccessCode()"]');
    if (generateBtn) {
        let isGenerating = false;
        generateBtn.addEventListener('click', function(e) {
            if (isGenerating) {
                e.preventDefault();
                e.stopPropagation();
                return;
            }
            
            isGenerating = true;
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Generating...';
            
            setTimeout(() => {
                isGenerating = false;
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-plus mr-1"></i> Generate Access Code';
            }, 3000);
        });
    }
    document.getElementById('admin-login-btn').addEventListener('click', adminLogin);
    document.getElementById('admin-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') adminLogin();
    });
    document.getElementById('logout-btn').addEventListener('click', adminLogout);
    document.getElementById('admin-back-btn').addEventListener('click', showAdminEmailList);
    document.getElementById('admin-delete-email-btn').addEventListener('click', deleteCurrentEmail);
    
    // Enhanced search functionality
    const searchInput = document.getElementById('email-search');
    if (searchInput) {
        searchInput.addEventListener('input', searchEmails);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchEmails();
            }
        });
    }
    showLoginScreen();
    // ONLY check admin status - NO data loading until logged in
    checkAdminStatus();
});

function checkAdminStatus() {
    console.log('üîê Checking admin authentication status...');
    
    // FORCE LOGIN SCREEN - Always show login regardless of backend status
    console.log('üõë Forcing login screen display');
    showLoginScreen();
    
    // Optional: Still check backend but don't auto-login
    fetch(`${API_URL}/api/admin/status`, {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Cache-Control': 'no-cache'
        }
    })
    .then(res => {
        console.log('Admin status response:', res.status);
        return res.json();
    })
    .then(data => {
        console.log('Admin status data (for info only):', data);
        // Don't auto-login even if backend says authenticated
        // showLoginScreen(); // Already called above
    })
    .catch(err => {
        console.log('Admin status check failed:', err.message);
        showLoginScreen();
    });
}




function showLoginScreen() {
    console.log('üõë FORCING login screen display');
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('admin-dashboard').style.display = 'none';
    
    // Clear any password field and errors
    document.getElementById('admin-password').value = '';
    document.getElementById('admin-login-error').style.display = 'none';
    
    // Focus on password field
    setTimeout(() => {
        document.getElementById('admin-password').focus();
    }, 100);
}

function showAdminDashboard() {
    console.log('üîÑ Loading admin dashboard with all data...');
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('admin-dashboard').style.display = 'block';
    
    // Load all admin data
    loadStats();
    loadAddresses();
    loadActiveSessions();
    loadAccessCodes();
    loadBlacklist();
    loadDomainsForAdmin();
    
    // Start auto-refresh and countdown
    startAutoRefresh();
    startAccessCodeCountdown();
    
    showNotification('‚úÖ Admin dashboard loaded successfully', 'success');
}
function startAccessCodeCountdown() {
    setInterval(() => {
        // Update all active access code displays
        document.querySelectorAll('[data-expires-at]').forEach(element => {
            const expiresAt = element.getAttribute('data-expires-at');
            if (expiresAt) {
                const timeRemaining = getTimeRemaining(expiresAt);
                element.textContent = timeRemaining;
                
                // Update status if expired
                if (timeRemaining === 'Expired') {
                    const statusElement = element.closest('.access-code-item').querySelector('.status-badge');
                    if (statusElement) {
                        statusElement.innerHTML = '<span class="bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">Expired</span>';
                    }
                }
            }
        });
    }, 60000); // Update every minute
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}


function loadBlacklist() {
    fetch(`${API_URL}/api/admin/blacklist`, {
        credentials: 'include'
    })
    .then(res => {
        if (res.status === 401) {
            location.reload();
            return;
        }
        return res.json();
    })
    .then(data => {
        const blacklistEl = document.getElementById('blacklist-list');
        
        if (!data || data.error) {
            blacklistEl.innerHTML = '<p class="text-red-400 text-center py-8">Error loading blacklist</p>';
            return;
        }
        
        if (!data.blacklist || data.blacklist.length === 0) {
            blacklistEl.innerHTML = '<p class="text-gray-400 text-center py-8">No blacklisted usernames</p>';
            return;
        }
        
        blacklistEl.innerHTML = '';
        
        // Sort blacklist by added_at (newest first)
        const sortedBlacklist = data.blacklist.sort((a, b) => {
            const timeA = a.added_at ? new Date(a.added_at) : new Date(0);
            const timeB = b.added_at ? new Date(b.added_at) : new Date(0);
            return timeB - timeA;
        });
        
        sortedBlacklist.forEach(item => {
            let username;
            let addedAt;
            
            if (typeof item === 'string') {
                username = item;
                addedAt = null;
            } else if (typeof item === 'object' && item !== null) {
                username = item.username || item.name || item.value || String(item);
                addedAt = item.added_at;
            } else {
                username = String(item);
                addedAt = null;
            }
            
            const addedTime = addedAt ? formatTimeDetailed(addedAt) : 'unknown';
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'bg-gray-800 p-3 rounded-lg border border-red-500 flex justify-between items-center blacklisted-item';
            itemDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-ban text-red-400 mr-3"></i>
                    <div>
                        <span class="text-white font-semibold text-sm">${escapeHtml(username)}</span>
                        <span class="text-xs text-gray-400 ml-2">@${DOMAIN}</span>
                        <div class="text-xs text-gray-500 mt-1">
                            ${item.added_by ? `by ${escapeHtml(item.added_by)} ‚Ä¢ ` : ''}${addedTime}
                        </div>
                    </div>
                </div>
                <button onclick="removeFromBlacklist('${escapeHtml(username)}')" 
                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors flex items-center"
                        title="Remove from blacklist">
                    <i class="fas fa-times mr-1"></i>Remove
                </button>
            `;
            blacklistEl.appendChild(itemDiv);
        });
    })
    .catch(err => {
        console.error('Error loading blacklist:', err);
        document.getElementById('blacklist-list').innerHTML = 
            '<p class="text-red-400 text-center py-8">Failed to load blacklist</p>';
    });
}

// Delete all emails for address - ENDS sessions
function deleteAddress(address) {
    showModal(
        'Delete All Emails',
        `Are you sure you want to delete ALL emails for <strong>${escapeHtml(address)}</strong>?<br><br>This action cannot be undone and will permanently remove all emails for this address. All active sessions for this address will be ended.`,
        function() {
            fetch(API_URL + '/api/admin/delete-address/' + encodeURIComponent(address), {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Also end any active sessions for this address
                    endSessionsForAddress(address);
                    
                    loadAddresses();
                    loadStats();
                    document.getElementById('email-details').innerHTML = '<p class="text-gray-400 text-center py-8">Select an email address to view emails</p>';
                    document.getElementById('selected-address').textContent = 'None selected';
                    document.getElementById('email-count-badge').classList.add('hidden');
                    showNotification('‚úÖ All emails deleted and sessions ended for ' + address, 'success');
                } else {
                    showNotification('‚ùå Failed to delete emails', 'error');
                }
            })
            .catch(err => {
                console.error('Error deleting address:', err);
                showNotification('‚ùå Error deleting emails', 'error');
            });
        }
    );
}

// Function to end sessions for a specific address
function endSessionsForAddress(emailAddress) {
    fetch(API_URL + '/api/admin/end-sessions/' + encodeURIComponent(emailAddress), {
        method: 'POST',
        credentials: 'include'
    })
    .then(res => {
        if (res.ok) {
            console.log(`‚úÖ Sessions ended for ${emailAddress}`);
        }
    })
    .catch(err => {
        console.error('Error ending sessions:', err);
    });
}

// Add detailed time formatting function
function formatTimeDetailed(timestamp) {
    if (!timestamp) return 'unknown';
    
    try {
        let date;
        if (typeof timestamp === 'string') {
            const cleanTimestamp = timestamp.replace(/[\+\-]\d{2}:?\d{2}$/, '');
            date = new Date(cleanTimestamp + 'Z');
            
            if (isNaN(date.getTime())) {
                date = new Date(timestamp);
            }
        } else {
            date = new Date(timestamp);
        }
        
        if (isNaN(date.getTime())) {
            return 'unknown';
        }
        
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (minutes < 1) return 'just now';
        if (minutes < 60) return `${minutes} min ago`;
        if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        if (days < 7) return `${days} day${days > 1 ? 's' : ''} ago`;
        
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
    } catch (e) {
        console.error('Error formatting detailed time:', e);
        return 'unknown';
    }
}



// Add this new function for access code creation times
function formatAccessCodeTime(timestamp) {
    try {
        let date;
        
        if (typeof timestamp === 'string') {
            // Parse the timestamp directly without timezone manipulation
            date = new Date(timestamp);
        } else {
            return 'recently';
        }
        
        if (isNaN(date.getTime())) {
            return 'recently';
        }
        date = new Date(date.getTime() + (6.5 * 60 * 60 * 1000));

        // Use server time directly without Myanmar conversion
        const now = new Date();
        const diff = now - date;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        // Return relative time (same logic but no timezone conversion)
        if (seconds < 60) return 'just now';
        if (minutes < 60) return minutes + ' min ago';
        if (hours < 24) return hours + ' hour' + (hours > 1 ? 's' : '') + ' ago';
        if (days < 7) return days + ' day' + (days > 1 ? 's' : '') + ' ago';
        
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
    } catch (e) {
        console.error('Error formatting access code time:', e);
        return 'recently';
    }
}

function addToBlacklist() {
    var usernameInput = document.getElementById('new-blacklist-username');
    var username = usernameInput.value.trim().toLowerCase();
    
    if (!username) {
        showNotification('‚ùå Please enter a username', 'error');
        return;
    }
    
    if (!/^[a-zA-Z0-9-_]+$/.test(username)) {
        showNotification('‚ùå Username can only contain letters, numbers, hyphens, and underscores', 'error');
        return;
    }
    

    showModal(
        'Add to Blacklist',
        `Are you sure you want to blacklist the username "<strong>${escapeHtml(username)}</strong>"?<br><br>This will prevent all users from using this username.`,
        function() {
            fetch(API_URL + '/api/admin/blacklist', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({username: username})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showNotification(`‚úÖ ${data.message}`, 'success');
                    usernameInput.value = '';
                    loadBlacklist();
                } else {
                    showNotification(`‚ùå ${data.error || 'Failed to add to blacklist'}`, 'error');
                }
            })
            .catch(err => {
                console.error('Error adding to blacklist:', err);
                showNotification('‚ùå Error adding to blacklist', 'error');
            });
        }
    );
}

function removeFromBlacklist(username) {
    showModal(
        'Remove from Blacklist',
        `Are you sure you want to remove "<strong>${escapeHtml(username)}</strong>" from the blacklist?<br><br>Users will be able to use this username again.`,
        function() {
            fetch(API_URL + '/api/admin/blacklist/' + encodeURIComponent(username), {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showNotification(`‚úÖ ${data.message}`, 'success');
                    loadBlacklist();
                } else {
                    showNotification(`‚ùå ${data.error || 'Failed to remove from blacklist'}`, 'error');
                }
            })
            .catch(err => {
                console.error('Error removing from blacklist:', err);
                showNotification('‚ùå Error removing from blacklist', 'error');
            });
        }
    );
}


function generateAccessCode() {
    const username = document.getElementById('generate-code-email').value.trim();
    const domainSelect = document.getElementById('generate-code-domain');
    const domain = domainSelect.value;
    const customCode = document.getElementById('generate-code-custom').value.trim();
    const description = document.getElementById('generate-code-description').value.trim();
    const durationSelect = document.getElementById('generate-code-duration');
    const maxUses = parseInt(document.getElementById('generate-code-uses').value) || 1;
    
    if (!username) {
        showNotification('‚ùå Please enter a username', 'error');
        return;
    }
    
    if (!domain) {
        showNotification('‚ùå Please select a domain', 'error');
        return;
    }
    
    // Validate username format
    if (!/^[a-zA-Z0-9-_]+$/.test(username)) {
        showNotification('‚ùå Username can only contain letters, numbers, hyphens, and underscores', 'error');
        return;
    }
    
    const email = `${username}@${domain}`;
    
    // Rest of your existing generateAccessCode function remains the same...
    let durationMinutes;
    if (durationSelect.value === 'custom') {
        durationMinutes = parseInt(customMinutes);
        if (!durationMinutes || durationMinutes < 1) {
            showNotification('‚ùå Please enter valid custom minutes', 'error');
            return;
        }
    } else {
        durationMinutes = parseInt(durationSelect.value);
    }
    
    const requestData = {
        email_address: email,
        max_uses: maxUses,
        duration_minutes: durationMinutes
    };
    
    if (customCode) {
        requestData.custom_code = customCode;
    }
    
    if (description) {
        requestData.description = description;
    }
    
    // Rest of your existing fetch code...
    fetch(`${API_URL}/api/admin/access-codes/generate`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify(requestData)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showNotification(`‚úÖ Access code generated: ${data.code} for ${data.email_address}`, 'success');
            // Clear form
            document.getElementById('generate-code-email').value = '';
            document.getElementById('generate-code-custom').value = '';
            document.getElementById('generate-code-description').value = '';
            document.getElementById('generate-code-uses').value = '1';
            durationSelect.value = '1440';
            // Reload list
            loadAccessCodes();
        } else {
            showNotification(`‚ùå ${data.error}`, 'error');
        }
    })
    .catch(err => {
        console.error('Error generating access code:', err);
        showNotification('‚ùå Error generating access code', 'error');
    });
}

function revokeAccessCode(code) {
    if (!code) {
        showNotification('‚ùå No access code provided', 'error');
        return;
    }
    
    showModal(
        'Revoke Access Code',
        `Are you sure you want to revoke access code <strong>${code}</strong>?<br><br>This will prevent anyone from using this code to access the email.`,
        function() {
            fetch(`${API_URL}/api/admin/access-codes/${code}/revoke`, {
                method: 'POST',
                credentials: 'include'
            })
            .then(res => {
                if (!res.ok) {
                    return res.json().then(errorData => {
                        throw new Error(errorData.error || `HTTP ${res.status}`);
                    });
                }
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    showNotification(`‚úÖ Access code ${code} revoked`, 'success');
                    loadAccessCodes(); // Reload the list
                } else {
                    showNotification(`‚ùå ${data.error}`, 'error');
                }
            })
            .catch(err => {
                console.error('Error revoking access code:', err);
                showNotification(`‚ùå ${err.message || 'Error revoking access code'}`, 'error');
            });
        }
    );
}

// Enhanced error handling wrapper
function handleAdminApiError(error, context = 'operation') {
    console.error(`Admin ${context} error:`, error);
    
    if (error.message && error.message.includes('Failed to fetch')) {
        showNotification('‚ùå Network error - check your connection', 'error');
    } else if (error.message && (error.message.includes('401') || error.message.includes('403'))) {
        showNotification('‚ùå Session expired - please login again', 'error');
        setTimeout(() => location.reload(), 2000);
    } else {
        showNotification(`‚ùå ${error.message || `Failed to complete ${context}`}`, 'error');
    }
}

// Enhanced fetch wrapper with error handling
async function adminFetch(url, options = {}) {
    try {
        const response = await fetch(url, {
            credentials: 'include',
            ...options
        });
        
        if (response.status === 401) {
            throw new Error('Session expired');
        }
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        handleAdminApiError(error, 'fetch operation');
        throw error;
    }
}


// End user session from admin
function endUserSession(sessionToken, email) {
    showModal(
        'End User Session',
        `Are you sure you want to end the session for <strong>${escapeHtml(email)}</strong>?<br><br>The user will be logged out and lose access to their emails.`,
        function() {
            fetch(API_URL + '/api/admin/session/' + sessionToken + '/end', {
                method: 'POST',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showNotification(`‚úÖ Session ended for ${email}`, 'success');
                    loadActiveSessions();
                } else {
                    showNotification(`‚ùå ${data.error || 'Failed to end session'}`, 'error');
                }
            })
            .catch(err => {
                console.error('Error ending session:', err);
                showNotification('‚ùå Error ending session', 'error');
            });
        }
    );
}

function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
    
    // Only refresh if we're actually in the admin dashboard
    autoRefreshInterval = setInterval(() => {
        if (document.getElementById('admin-dashboard').style.display !== 'none') {
            loadStats();
            loadAddresses();
            loadActiveSessions();
            loadBlacklist();
            loadAccessCodes();
        }
    }, 15000);
}

// Custom Modal Functions
function showModal(title, message, confirmCallback) {
    const modal = document.getElementById('custom-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirm = document.getElementById('modal-confirm');
    const modalCancel = document.getElementById('modal-cancel');
    
    modalTitle.textContent = title;
    modalMessage.innerHTML = message;
    modal.classList.remove('hidden');
    
    // Remove previous event listeners
    const newConfirm = modalConfirm.cloneNode(true);
    const newCancel = modalCancel.cloneNode(true);
    modalConfirm.parentNode.replaceChild(newConfirm, modalConfirm);
    modalCancel.parentNode.replaceChild(newCancel, modalCancel);
    
    // Add new event listeners
    document.getElementById('modal-confirm').onclick = function() {
        modal.classList.add('hidden');
        if (confirmCallback) confirmCallback();
    };
    
    document.getElementById('modal-cancel').onclick = function() {
        modal.classList.add('hidden');
    };
}

function adminLogin() {
    if (loginAttemptInProgress) {
        console.log('üõë Login attempt already in progress');
        return;
    }
    
    var password = document.getElementById('admin-password').value;
    var errorEl = document.getElementById('admin-login-error');
    var btn = document.getElementById('admin-login-btn');
    
    if (!password) {
        errorEl.textContent = '‚ùå Please enter password';
        errorEl.style.display = 'block';
        return;
    }
    
    // Set loading state
    loginAttemptInProgress = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Logging in...';
    btn.disabled = true;
    errorEl.style.display = 'none';
    
    console.log('üîê Attempting admin login...');
    
    fetch(API_URL + '/api/admin/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify({password: password})
    })
    .then(res => {
        console.log('Login response status:', res.status);
        if (res.ok) {
            return res.json();
        }
        throw new Error('Login failed');
    })
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Admin login successful');
            showAdminDashboard();
            showNotification('‚úÖ Successfully logged in', 'success');
        } else {
            throw new Error('Invalid password');
        }
    })
    .catch(err => {
        console.error('‚ùå Admin login error:', err);
        errorEl.textContent = '‚ùå ' + (err.message || 'Login failed');
        errorEl.style.display = 'block';
    })
    .finally(() => {
        // Reset button state
        loginAttemptInProgress = false;
        btn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Login';
        btn.disabled = false;
    });
}

// Logout handler
function adminLogout() {
    showModal(
        'Confirm Logout',
        'Are you sure you want to logout from the admin panel?',
        function() {
            fetch(API_URL + '/api/admin/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(() => {
                location.reload();
            })
            .catch(() => {
                location.reload();
            });
        }
    );
}



function formatPlainTextEmail(text) {
    if (!text) return '<p class="text-gray-400">No content</p>';
    
    let formatted = escapeHtml(text)
        .replace(/\n/g, '<br>')
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-blue-400 hover:underline">$1</a>');
    
    return `<div class="text-gray-200 leading-relaxed">${formatted}</div>`;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        showNotification('‚úÖ Copied: ' + text, 'success');
    }).catch(function() {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('‚úÖ Copied: ' + text, 'success');
    });
}


function prepareEmailForIframe(rawBody) {
    if (!rawBody || rawBody.trim() === '') {
        return {
            isHtml: false,
            content: '<p class="text-gray-400 text-center py-8">No content available</p>'
        };
    }

    // Return the raw body wrapped in a dark container
    return { 
        isHtml: false, 
        content: `<div class="bg-gray-900/80 p-4 rounded-lg min-h-full email-original">${rawBody}</div>`
    };
}

// Global variables for search
let allAddresses = [];
let blacklistedUsernames = [];
let currentSearchTerm = '';

// Search function
function searchEmails() {
    currentSearchTerm = document.getElementById('email-search').value.toLowerCase().trim();
    const clearBtn = document.getElementById('clear-search-btn');
    
    // Show/hide clear button
    if (currentSearchTerm) {
        clearBtn.classList.remove('hidden');
    } else {
        clearBtn.classList.add('hidden');
    }
    
    if (!allAddresses.length) {
        document.getElementById('address-list').innerHTML = '<p class="text-gray-400 text-center py-8">No addresses to search</p>';
        return;
    }
    
    let filteredAddresses = allAddresses;
    
    if (currentSearchTerm) {
        filteredAddresses = allAddresses.filter(addr => {
            const username = addr.address.split('@')[0].toLowerCase();
            return username.includes(currentSearchTerm);
        });
    }
    
    renderAddressList(filteredAddresses);
}

// Clear search
function clearSearch() {
    document.getElementById('email-search').value = '';
    currentSearchTerm = '';
    document.getElementById('clear-search-btn').classList.add('hidden');
    searchEmails();
}

function loadDomainsForAdmin() {
    fetch(`${API_URL}/api/domains`)
    .then(res => res.json())
    .then(data => {
        const domainSelect = document.getElementById('generate-code-domain');
        if (domainSelect && data.domains && data.domains.length > 0) {
            domainSelect.innerHTML = '<option value="">Select domain</option>';
            data.domains.forEach(domain => {
                const option = document.createElement('option');
                option.value = domain;
                option.textContent = `@${domain}`;
                domainSelect.appendChild(option);
            });
            
            // Auto-select the first domain if only one exists
            if (data.domains.length === 1) {
                domainSelect.value = data.domains[0];
            }
        }
    })
    .catch(err => {
        console.error('Error loading domains for admin:', err);
        // Fallback to default domain
        const domainSelect = document.getElementById('generate-code-domain');
        if (domainSelect) {
            domainSelect.innerHTML = '<option value="">Select domain</option>';
            const option = document.createElement('option');
            option.value = 'aungmyomyatzaw.online';
            option.textContent = '@aungmyomyatzaw.online';
            domainSelect.appendChild(option);
        }
    });
}

// Enhanced address list rendering
function renderAddressList(addresses) {
    const list = document.getElementById('address-list');
    
    if (addresses.length === 0) {
        if (currentSearchTerm) {
            list.innerHTML = '<p class="text-gray-400 text-center py-8">No addresses found for "' + currentSearchTerm + '"</p>';
        } else {
            list.innerHTML = '<p class="text-gray-400 text-center py-8">No email addresses yet</p>';
        }
        return;
    }
    
    list.innerHTML = '';
    
    // Sort addresses by last_email_time (newest first)
    addresses.sort((a, b) => {
        if (!a.last_email_time && !b.last_email_time) return 0;
        if (!a.last_email_time) return 1;
        if (!b.last_email_time) return -1;
        return new Date(b.last_email_time) - new Date(a.last_email_time);
    });
    
    addresses.forEach(addr => {
        const username = addr.address.split('@')[0];
        const isBlacklisted = blacklistedUsernames.includes(username.toLowerCase());
        
        // Highlight search term in username
        let displayUsername = escapeHtml(username);
        if (currentSearchTerm) {
            const regex = new RegExp(`(${escapeRegex(currentSearchTerm)})`, 'gi');
            displayUsername = username.replace(regex, '<mark class="bg-yellow-200 text-yellow-900 px-1 rounded">$1</mark>');
        }
        
        const item = document.createElement('div');
        item.className = `address-item rounded-lg border p-3 transition-all cursor-pointer ${
            isBlacklisted 
                ? 'bg-red-900/20 border-red-500 hover:bg-red-800/30' 
                : 'bg-gray-800 border-gray-700 hover:border-gray-600 hover:bg-gray-700'
        }`;
        
        item.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="flex items-center min-w-0 flex-1">
                            <p class="text-white font-semibold truncate text-sm">
                                <span class="username">${displayUsername}</span>
                                <span class="text-gray-400">@${DOMAIN}</span>
                            </p>
                            ${isBlacklisted ? 
                                '<span class="bg-red-500 text-white px-2 py-1 rounded text-xs font-bold flex-shrink-0 ml-2 flex items-center"><i class="fas fa-ban mr-1"></i>Blacklisted</span>' : 
                                ''
                            }
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4 text-xs text-gray-400">
                            <span class="flex items-center">
                                <i class="fas fa-envelope mr-1"></i>
                                ${addr.count || 0} email${(addr.count || 0) !== 1 ? 's' : ''}
                            </span>
                            <span class="flex items-center">
                                <i class="fas fa-clock mr-1"></i>
                                ${addr.last_email || 'never'}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-1 ml-3 flex-shrink-0">
                    <button onclick="event.stopPropagation(); viewEmails('${escapeHtml(addr.address)}')" 
                            class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded transition-colors flex items-center justify-center"
                            title="View emails">
                        <i class="fas fa-eye text-xs"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteAddress('${escapeHtml(addr.address)}')" 
                            class="bg-red-600 hover:bg-red-700 text-white p-2 rounded transition-colors flex items-center justify-center"
                            title="Delete all emails">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                    ${!isBlacklisted ? 
                        `<button onclick="event.stopPropagation(); blacklistFromAddress('${escapeHtml(username)}')" 
                                class="bg-orange-600 hover:bg-orange-700 text-white p-2 rounded transition-colors flex items-center justify-center"
                                title="Blacklist username">
                            <i class="fas fa-ban text-xs"></i>
                        </button>` : 
                        ''
                    }
                </div>
            </div>
        `;
        
        // Add click handler to view emails
        item.addEventListener('click', function(e) {
            if (!e.target.closest('button')) {
                viewEmails(addr.address);
            }
        });
        
        list.appendChild(item);
    });
}

// Load blacklist for highlighting
function loadBlacklistForHighlight() {
    return fetch(`${API_URL}/api/admin/blacklist`, {
        credentials: 'include'
    })
    .then(res => res.json())
    .then(data => {
        if (data && data.blacklist) {
            blacklistedUsernames = data.blacklist.map(item => {
                if (typeof item === 'string') return item.toLowerCase();
                if (typeof item === 'object' && item.username) return item.username.toLowerCase();
                return String(item).toLowerCase();
            }).filter(username => username); // Remove empty strings
            console.log('Loaded blacklisted usernames:', blacklistedUsernames);
        }
        return data;
    })
    .catch(err => {
        console.error('Error loading blacklist for highlighting:', err);
        return [];
    });
}

// Blacklist username directly from address list
function blacklistFromAddress(username) {
    showModal(
        'Blacklist Username',
        `Are you sure you want to blacklist the username "<strong>${escapeHtml(username)}</strong>"?<br><br>This will prevent all users from using this username.`,
        function() {
            fetch(API_URL + '/api/admin/blacklist', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({username: username.toLowerCase()})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showNotification(`‚úÖ Username ${username} added to blacklist`, 'success');
                    // Reload blacklist and refresh the display
                    loadBlacklistForHighlight().then(() => {
                        searchEmails(); // Re-apply current search/filter
                    });
                } else {
                    showNotification(`‚ùå ${data.error || 'Failed to blacklist username'}`, 'error');
                }
            })
            .catch(err => {
                console.error('Error blacklisting username:', err);
                showNotification('‚ùå Error blacklisting username', 'error');
            });
        }
    );
}

function getTimeRemaining(expiresAt) {
    const now = new Date();
    const expires = new Date(expiresAt);
    const diff = expires - now;
    
    if (diff <= 0) return 'Expired';
    
    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) return `${days}d ${hours % 24}h ${minutes % 60}m`;
    if (hours > 0) return `${hours}h ${minutes % 60}m`;
    if (minutes > 0) return `${minutes}m`;
    return 'Less than 1m';
}

// Update the existing loadAddresses function
function loadAddresses() {
    fetch(API_URL + '/api/admin/addresses', {
        credentials: 'include'
    })
    .then(res => {
        if (res.status === 401) {
            location.reload();
            return;
        }
        return res.json();
    })
    .then(data => {
        if (!data || data.error) {
            document.getElementById('address-list').innerHTML = '<p class="text-red-400 text-center py-8">Error loading addresses</p>';
            return;
        }
        
        allAddresses = data.addresses || [];
        console.log('Loaded addresses:', allAddresses.length);
        
        // Load blacklist for highlighting, then render
        loadBlacklistForHighlight().then(() => {
            searchEmails(); // This will render the list with current search
        });
    })
    .catch(err => {
        console.error('Error loading addresses:', err);
        document.getElementById('address-list').innerHTML = '<p class="text-red-400 text-center py-8">Failed to load addresses</p>';
    });
}

// Utility function to escape regex characters
function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Show email list
function showAdminEmailList() {
    document.getElementById('admin-email-list-view').classList.remove('hidden');
    document.getElementById('admin-email-content-view').classList.add('hidden');
    currentViewingEmail = null;
}

// Delete current email
function deleteCurrentEmail() {
    if (!currentViewingEmail) return;
    deleteEmail(currentViewingEmail.id);
}


function viewEmails(address) {
    selectedAddress = address;
    document.getElementById('selected-address').textContent = address;
    
    fetch(API_URL + '/api/admin/emails/' + encodeURIComponent(address), {
        credentials: 'include'
    })
    .then(res => res.json())
    .then(data => {
        var details = document.getElementById('email-details');
        var badge = document.getElementById('email-count-badge');
        
        if (!data || data.error) {
            details.innerHTML = '<p class="text-red-400 text-center py-8">Error loading emails</p>';
            badge.classList.add('hidden');
            return;
        }
        
        if (!data.emails || data.emails.length === 0) {
            details.innerHTML = '<p class="text-gray-400 text-center py-8">No emails for this address</p>';
            badge.textContent = '0 emails';
            badge.classList.remove('hidden');
            return;
        }
        
        // Update badge
        badge.textContent = data.emails.length + ' email' + (data.emails.length !== 1 ? 's' : '');
        badge.classList.remove('hidden');
        
        details.innerHTML = '';
        
        data.emails.forEach((email, index) => {
            var item = document.createElement('div');
            item.className = 'bg-gray-800 p-3 md:p-4 rounded-lg border border-gray-700 hover:border-gray-600 transition-colors cursor-pointer';
            
            // Make entire card clickable
            item.onclick = function() {
                // Remove active class from all items
                document.querySelectorAll('#email-details > div').forEach(el => {
                    el.classList.remove('bg-blue-600', 'border-blue-500');
                });
                // Add active class to clicked item
                item.classList.add('bg-blue-600', 'border-blue-500');
                
                viewFullAdminEmail(email);
            };
            
            // Clean and truncate body for preview
            var cleanBody = email.body ? email.body.replace(/<[^>]+>/g, '').replace(/\s+/g, ' ').trim() : 'No content';
            var previewBody = cleanBody.length > 100 ? cleanBody.substring(0, 100) + '...' : cleanBody;
            
            item.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <p class="text-white font-semibold text-xs md:text-sm truncate">${escapeHtml(email.sender || 'Unknown')}</p>
                        <p class="text-gray-300 text-xs md:text-sm font-medium mt-1">${escapeHtml(email.subject || 'No subject')}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatTime(email.timestamp)}</p>
                    </div>
                    <button onclick="event.stopPropagation(); deleteEmail(${email.id})" 
                            class="text-red-400 hover:text-red-300 p-1 md:p-2 rounded transition-colors ml-2" 
                            title="Delete email">
                        <i class="fas fa-trash text-xs md:text-sm"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-2">${escapeHtml(previewBody)}</p>
                <div class="mt-2 text-xs text-blue-400 hover:text-blue-300">
                    <i class="fas fa-eye mr-1"></i>Click to view full email
                </div>
            `;
            
            details.appendChild(item);
        });
    })
    .catch(err => {
        console.error('Error loading emails:', err);
        document.getElementById('email-details').innerHTML = '<p class="text-red-400 text-center py-8">Failed to load emails</p>';
    });
}

function viewFullAdminEmail(email) {
    currentViewingEmail = email;
    
    // Hide list, show content
    document.getElementById('admin-email-list-view').classList.add('hidden');
    document.getElementById('admin-email-content-view').classList.remove('hidden');
    
    // Populate email details
    document.getElementById('admin-email-subject').textContent = email.subject || 'No subject';
    document.getElementById('admin-email-from').textContent = email.sender || 'Unknown';
    document.getElementById('admin-email-date').textContent = formatTime(email.timestamp);
    
    const iframe = document.getElementById('admin-email-iframe');
    const fallback = document.getElementById('admin-email-fallback');
    
    // ‚úÖ ALWAYS USE FALLBACK DIV - NEVER USE IFRAME
    iframe.classList.add('hidden');
    fallback.classList.remove('hidden');
    
    // Use the raw body content directly
    fallback.innerHTML = email.body || '<p class="text-gray-400 text-center py-8">No content available</p>';
    
    // Add click handlers for verification codes and improve styling
    setTimeout(() => {
        // Make verification codes clickable to copy
        const verificationCodes = fallback.querySelectorAll('.bg-yellow-200, .bg-gradient-to-r, [class*="verification"], [class*="code"]');
        verificationCodes.forEach(codeElement => {
            const code = codeElement.textContent.trim();
            if (code && code.length >= 4 && code.length <= 8 && /^\d+$/.test(code)) {
                codeElement.style.cursor = 'pointer';
                codeElement.addEventListener('click', function() {
                    copyToClipboard(code);
                });
            }
        });
        
        // Make all links open in new tab
        const links = fallback.querySelectorAll('a');
        links.forEach(link => {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
            link.classList.add('text-blue-400', 'hover:underline');
        });
        
        // Improve overall styling for dark mode
        const emailContent = fallback.querySelector('.email-original');
        if (emailContent) {
            emailContent.classList.add('text-gray-200', 'leading-relaxed');
        }
    }, 100);
}

// Add this copy function to admin panel JavaScript
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        showNotification('‚úÖ Verification code copied: ' + text, 'success');
    }).catch(function() {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('‚úÖ Verification code copied: ' + text, 'success');
    });
}

// Delete single email
function deleteEmail(emailId) {
    showModal(
        'Delete Email',
        'Are you sure you want to delete this email? This action cannot be undone.',
        function() {
            fetch(API_URL + '/api/admin/delete/' + emailId, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (selectedAddress) viewEmails(selectedAddress);
                    loadStats();
                    showNotification('‚úÖ Email deleted successfully', 'success');
                } else {
                    showNotification('‚ùå Failed to delete email', 'error');
                }
            })
            .catch(err => {
                console.error('Error deleting email:', err);
                showNotification('‚ùå Error deleting email', 'error');
            });
        }
    );
}

// Delete all emails for address
function deleteAddress(address) {
    showModal(
        'Delete All Emails',
        `Are you sure you want to delete ALL emails for <strong>${escapeHtml(address)}</strong>?<br><br>This action cannot be undone and will permanently remove all emails for this address.`,
        function() {
            fetch(API_URL + '/api/admin/delete-address/' + encodeURIComponent(address), {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    loadAddresses();
                    loadStats();
                    document.getElementById('email-details').innerHTML = '<p class="text-gray-400 text-center py-8">Select an email address to view emails</p>';
                    document.getElementById('selected-address').textContent = 'None selected';
                    document.getElementById('email-count-badge').classList.add('hidden');
                    showNotification('‚úÖ All emails deleted for ' + address, 'success');
                } else {
                    showNotification('‚ùå Failed to delete emails', 'error');
                }
            })
            .catch(err => {
                console.error('Error deleting address:', err);
                showNotification('‚ùå Error deleting emails', 'error');
            });
        }
    );
}

// Load stats
function loadStats() {
    fetch(API_URL + '/api/admin/stats', {
        credentials: 'include'
    })
    .then(res => res.json())
    .then(data => {
        if (data && !data.error) {
            document.getElementById('stat-emails').textContent = data.total_emails || 0;
            document.getElementById('stat-addresses').textContent = data.total_addresses || 0;
            document.getElementById('stat-recent').textContent = data.recent_emails || 0;
        }
    })
    .catch(err => {
        console.error('Error loading stats:', err);
    });
}

// Load active sessions with end session functionality
function loadActiveSessions() {
    fetch(API_URL + '/api/admin/sessions', {
        credentials: 'include'
    })
    .then(res => {
        if (res.status === 401) {
            location.reload();
            return;
        }
        return res.json();
    })
    .then(data => {
        var sessionsEl = document.getElementById('active-sessions');
        
        if (!data || data.error) {
            sessionsEl.innerHTML = '<p class="text-red-400 text-center py-8">Error loading sessions</p>';
            return;
        }
        
        if (!data.sessions || data.sessions.length === 0) {
            sessionsEl.innerHTML = '<p class="text-gray-400 text-center py-8">No active sessions</p>';
            return;
        }
        
        sessionsEl.innerHTML = '';
        
        data.sessions.forEach(session => {
            var item = document.createElement('div');
            item.className = 'session-item bg-gray-800 p-3 md:p-4 rounded-lg border border-gray-700 hover:border-gray-600';
            item.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <p class="text-white font-semibold text-xs md:text-sm truncate">${escapeHtml(session.email)}</p>
                        <div class="grid grid-cols-2 gap-2 mt-2 text-xs text-gray-400">
                            <div>
                                <i class="fas fa-play-circle mr-1"></i>
                                ${session.session_age_minutes} min ago
                            </div>
                            <div>
                                <i class="fas fa-clock mr-1"></i>
                                ${session.time_remaining_minutes} min left
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Last active: ${formatTime(session.last_activity)}
                        </p>
                    </div>
                    <button onclick="endUserSession('${session.session_token}', '${escapeHtml(session.email)}')" class="text-red-400 hover:text-red-300 p-1 md:p-2 rounded transition-colors ml-2" title="End Session">
                        <i class="fas fa-times-circle text-xs md:text-sm"></i>
                    </button>
                </div>
            `;
            sessionsEl.appendChild(item);
        });
    })
    .catch(err => {
        console.error('Error loading sessions:', err);
        document.getElementById('active-sessions').innerHTML = '<p class="text-red-400 text-center py-8">Failed to load sessions</p>';
    });
}

function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Replace the formatTime function with this:
function formatTime(timestamp) {
    if (!timestamp) return 'never';
    
    try {
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) return 'invalid';
        
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (minutes < 1) return 'just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;
        
        return date.toLocaleDateString();
    } catch (e) {
        return 'error';
    }
}

function formatFutureTime(timestamp) {
    if (!timestamp) return 'never';
    
    try {
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) return 'invalid';
        
        // Add 6 hours to the display ONLY
        const displayDate = new Date(date.getTime() + (6 * 60 * 60 * 1000));
        
        const now = new Date();
        const diff = displayDate - now;
        
        if (diff <= 0) return 'Expired';
        
        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (days > 0) return `${days}d ${hours % 24}h`;
        if (hours > 0) return `${hours}h ${minutes % 60}m`;
        if (minutes > 0) return `${minutes}m`;
        return '<1m';
    } catch (e) {
        return 'error';
    }
}


// Update the loadAccessCodes function to use proper time display:
function loadAccessCodes() {
    fetch(`${API_URL}/api/admin/access-codes`, {
        credentials: 'include'
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
        }
        return res.json();
    })
    .then(data => {
        const list = document.getElementById('access-codes-list');
        
        if (!data || data.error) {
            list.innerHTML = '<p class="text-red-400 text-center py-8">Error loading access codes</p>';
            return;
        }
        
        if (!data.access_codes || data.access_codes.length === 0) {
            list.innerHTML = '<p class="text-gray-400 text-center py-8">No access codes generated yet</p>';
            return;
        }
        
        list.innerHTML = '';
        
        data.access_codes.forEach(code => {
            const now = new Date();
            const expiresAt = new Date(code.expires_at);
            const isExpired = expiresAt < now;
            const isUsedUp = code.remaining_uses <= 0;
            const isRevoked = !code.is_active;
            
            const statusClass = isRevoked ? 'border-red-500 bg-red-900/20' : 
                              isExpired ? 'border-orange-500 bg-orange-900/20' :
                              isUsedUp ? 'border-yellow-500 bg-yellow-900/20' : 
                              'border-green-500 bg-green-900/20';
            
            // Use future time for expiration, regular time for creation
            const timeRemaining = formatFutureTime(code.expires_at);
            const createdTime = formatAccessCodeTime(code.created_at);
            
            const item = document.createElement('div');
            item.className = `p-4 rounded-lg border ${statusClass} transition-all hover:scale-[1.02] access-code-item`;
            
            item.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <code class="text-white font-mono font-bold text-lg bg-black/30 px-2 py-1 rounded">${code.code}</code>
                            ${isExpired ? '<span class="bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">Expired</span>' : ''}
                            ${isRevoked ? '<span class="bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">Revoked</span>' : ''}
                            ${isUsedUp ? '<span class="bg-orange-500 text-white px-2 py-1 rounded text-xs font-bold">Used Up</span>' : ''}
                            ${!isExpired && !isRevoked && !isUsedUp ? '<span class="bg-green-500 text-white px-2 py-1 rounded text-xs font-bold">Active</span>' : ''}
                        </div>
                        <p class="text-white font-medium mb-1">${code.email_address}</p>
                        ${code.description ? `<p class="text-gray-300 text-sm mb-2">${escapeHtml(code.description)}</p>` : ''}
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                            <div>
                                <i class="fas fa-clock mr-1"></i>
                                ${isExpired ? 'Expired' : `Expires: ${timeRemaining}`}
                            </div>
                            <div>
                                <i class="fas fa-chart-bar mr-1"></i>
                                Uses: ${code.used_count || 0}/${code.max_uses}
                            </div>
                            <div>
                                <i class="fas fa-calendar mr-1"></i>
                                Created: ${createdTime}
                            </div>
                            <div>
                                <i class="fas fa-bolt mr-1"></i>
                                Status: ${isRevoked ? 'Revoked' : isExpired ? 'Expired' : isUsedUp ? 'Used Up' : 'Active'}
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 ml-4">
                        ${!isRevoked && !isExpired ? `
                            <button onclick="revokeAccessCode('${code.code}')" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-sm transition-colors flex items-center"
                                    title="Revoke Code">
                                <i class="fas fa-ban mr-1"></i>Revoke
                            </button>
                        ` : ''}
                        <button onclick="copyToClipboard('${code.code}')" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm transition-colors flex items-center"
                                title="Copy Code">
                            <i class="fas fa-copy mr-1"></i>Copy
                        </button>
                    </div>
                </div>
            `;
            
            list.appendChild(item);
        });
    })
    .catch(err => {
        console.error('Error loading access codes:', err);
        document.getElementById('access-codes-list').innerHTML = 
            '<p class="text-red-400 text-center py-8">Failed to load access codes</p>';
    });
}

function showNotification(message, type) {
    var bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
    var icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    var notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 md:px-6 py-2 md:py-3 rounded-lg shadow-lg z-50 fade-in flex items-center text-sm md:text-base`;
    notification.innerHTML = `<i class="fas ${icon} mr-2"></i>${message}`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('opacity-0');
        notification.classList.add('transition-opacity');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}
</script>
</body>
</html>
