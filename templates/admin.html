<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - TempMail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #7e22ce 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen p-4">
    <!-- Login Screen -->
    <div id="login-screen" class="flex justify-center items-center min-h-screen">
        <div class="glass-effect rounded-xl p-8 text-center max-w-md w-full">
            <i class="fas fa-shield-alt text-5xl text-white mb-4"></i>
            <h1 class="text-3xl font-bold text-white mb-2">Admin Panel</h1>
            <p class="text-gray-300 mb-6">TempMail System Administration</p>
            <input type="password" id="admin-password" placeholder="Enter admin password" 
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white mb-4 focus:outline-none focus:border-blue-500">
            <button id="admin-login-btn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-3 rounded-lg transition-all hover:scale-105">
                <i class="fas fa-sign-in-alt mr-2"></i>Login
            </button>
            <p id="admin-login-error" class="text-red-400 mt-4 hidden">‚ùå Invalid password</p>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="hidden w-full max-w-7xl mx-auto fade-in">
        <header class="text-center mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <div class="flex items-center">
                    <i class="fas fa-shield-alt text-3xl text-white mr-3"></i>
                    <h1 class="text-4xl font-bold text-white">Admin Dashboard</h1>
                </div>
                <div class="flex gap-2">
                    <a href="/" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Main Site
                    </a>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
            <p class="text-gray-300">Monitor and manage all temporary email addresses</p>
        </header>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="glass-effect rounded-xl p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Total Emails</p>
                        <p id="stat-emails" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <i class="fas fa-envelope text-4xl text-blue-400"></i>
                </div>
            </div>
            <div class="glass-effect rounded-xl p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Email Addresses</p>
                        <p id="stat-addresses" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <i class="fas fa-users text-4xl text-green-400"></i>
                </div>
            </div>
            <div class="glass-effect rounded-xl p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Last 24 Hours</p>
                        <p id="stat-recent" class="text-3xl font-bold text-white">0</p>
                    </div>
                    <i class="fas fa-clock text-4xl text-purple-400"></i>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Email Addresses -->
            <div class="glass-effect rounded-xl p-6 fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">
                        <i class="fas fa-list mr-2"></i>Email Addresses
                    </h2>
                    <button onclick="loadAddresses()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition-all">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
                <div id="address-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-gray-400 text-center py-8">Loading addresses...</p>
                </div>
            </div>

            <!-- Email Details -->
            <div class="glass-effect rounded-xl p-6 fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">
                        <i class="fas fa-envelope-open mr-2"></i>Emails for: 
                        <span id="selected-address" class="text-blue-400">None selected</span>
                    </h2>
                    <div id="email-count-badge" class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm hidden">
                        0 emails
                    </div>
                </div>
                <div id="email-details" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-gray-400 text-center py-8">Select an address to view emails</p>
                </div>
            </div>
        </div>

        <!-- Active Sessions -->
        <div class="glass-effect rounded-xl p-6 fade-in mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">
                    <i class="fas fa-play-circle mr-2"></i>Active Sessions
                </h2>
                <button onclick="loadActiveSessions()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-all">
                    <i class="fas fa-sync-alt mr-1"></i> Refresh
                </button>
            </div>
            <div id="active-sessions" class="space-y-2 max-h-64 overflow-y-auto">
                <p class="text-gray-400 text-center py-8">Loading active sessions...</p>
            </div>
        </div>

        <!-- Blacklist Management -->
        <div class="glass-effect rounded-xl p-6 fade-in">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                <h2 class="text-xl font-bold text-white">
                    <i class="fas fa-ban mr-2"></i>Blacklisted Usernames
                </h2>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                    <input type="text" id="new-blacklist-username" placeholder="Enter username to blacklist" 
                           class="bg-gray-700 text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none w-full sm:w-48 text-sm">
                    <button onclick="addToBlacklist()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-all whitespace-nowrap text-sm">
                        <i class="fas fa-plus mr-1"></i> Add to Blacklist
                    </button>
                </div>
            </div>
            <div id="blacklist-list" class="space-y-2 max-h-64 overflow-y-auto">
                <p class="text-gray-400 text-center py-8">Loading blacklist...</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let selectedAddress = null;
        let autoRefreshInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('admin-login-btn').addEventListener('click', adminLogin);
            document.getElementById('admin-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') adminLogin();
            });
            document.getElementById('logout-btn').addEventListener('click', adminLogout);
        });

        // Admin functions
        function adminLogin() {
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');
            const btn = document.getElementById('admin-login-btn');
            
            if (!password) {
                errorEl.textContent = '‚ùå Please enter password';
                errorEl.classList.remove('hidden');
                return;
            }
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Logging in...';
            btn.disabled = true;
            
            fetch(API_URL + '/api/admin/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({password: password})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                    loadStats();
                    loadAddresses();
                    loadActiveSessions();
                    loadBlacklist();
                    startAutoRefresh();
                    showNotification('‚úÖ Successfully logged in', 'success');
                } else {
                    throw new Error('Invalid password');
                }
            })
            .catch(err => {
                errorEl.textContent = '‚ùå ' + err.message;
                errorEl.classList.remove('hidden');
            })
            .finally(() => {
                btn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i>Login';
                btn.disabled = false;
            });
        }

        function adminLogout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch(API_URL + '/api/admin/logout', {
                    method: 'POST',
                    credentials: 'include'
                }).finally(() => {
                    location.reload();
                });
            }
        }

        function loadStats() {
            fetch(API_URL + '/api/admin/stats', {credentials: 'include'})
                .then(res => res.json())
                .then(data => {
                    if (data && !data.error) {
                        document.getElementById('stat-emails').textContent = data.total_emails || 0;
                        document.getElementById('stat-addresses').textContent = data.total_addresses || 0;
                        document.getElementById('stat-recent').textContent = data.recent_emails || 0;
                    }
                })
                .catch(console.error);
        }

        function loadAddresses() {
            fetch(API_URL + '/api/admin/addresses', {credentials: 'include'})
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('address-list');
                    
                    if (!data || data.error || !data.addresses || data.addresses.length === 0) {
                        list.innerHTML = '<p class="text-gray-400 text-center py-8">No email addresses yet</p>';
                        return;
                    }
                    
                    list.innerHTML = '';
                    data.addresses.forEach(addr => {
                        const item = document.createElement('div');
                        item.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-gray-600 transition-colors';
                        item.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <p class="text-white font-semibold truncate">${escapeHtml(addr.address)}</p>
                                    <p class="text-xs text-gray-400 mt-1">
                                        ${addr.count || 0} email${(addr.count || 0) !== 1 ? 's' : ''} ‚Ä¢ 
                                        ${formatTime(addr.last_email)}
                                    </p>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="viewEmails('${escapeHtml(addr.address)}')" class="text-blue-400 hover:text-blue-300 p-2 rounded transition-colors" title="View emails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="deleteAddress('${escapeHtml(addr.address)}')" class="text-red-400 hover:text-red-300 p-2 rounded transition-colors" title="Delete all emails">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                })
                .catch(err => {
                    console.error('Error loading addresses:', err);
                    document.getElementById('address-list').innerHTML = '<p class="text-red-400 text-center py-8">Failed to load addresses</p>';
                });
        }

        function viewEmails(address) {
            selectedAddress = address;
            document.getElementById('selected-address').textContent = address;
            
            fetch(API_URL + '/api/admin/emails/' + encodeURIComponent(address), {credentials: 'include'})
                .then(res => res.json())
                .then(data => {
                    const details = document.getElementById('email-details');
                    const badge = document.getElementById('email-count-badge');
                    
                    if (!data || data.error || !data.emails || data.emails.length === 0) {
                        details.innerHTML = '<p class="text-gray-400 text-center py-8">No emails for this address</p>';
                        badge.classList.add('hidden');
                        return;
                    }
                    
                    badge.textContent = data.emails.length + ' email' + (data.emails.length !== 1 ? 's' : '');
                    badge.classList.remove('hidden');
                    
                    details.innerHTML = '';
                    data.emails.forEach(email => {
                        const item = document.createElement('div');
                        item.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-gray-600 transition-colors';
                        item.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <p class="text-white font-semibold text-sm truncate">${escapeHtml(email.sender || 'Unknown')}</p>
                                    <p class="text-gray-300 text-sm font-medium mt-1">${escapeHtml(email.subject || 'No subject')}</p>
                                    <p class="text-xs text-gray-400 mt-1">${formatTime(email.timestamp)}</p>
                                </div>
                                <button onclick="deleteEmail(${email.id})" class="text-red-400 hover:text-red-300 p-2 rounded transition-colors ml-2" title="Delete email">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">${escapeHtml(email.body.substring(0, 100))}...</p>
                        `;
                        details.appendChild(item);
                    });
                })
                .catch(err => {
                    console.error('Error loading emails:', err);
                    document.getElementById('email-details').innerHTML = '<p class="text-red-400 text-center py-8">Failed to load emails</p>';
                });
        }

        function deleteEmail(emailId) {
            if (confirm('Are you sure you want to delete this email?')) {
                fetch(API_URL + '/api/admin/delete/' + emailId, {
                    method: 'DELETE',
                    credentials: 'include'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        if (selectedAddress) viewEmails(selectedAddress);
                        loadStats();
                        showNotification('‚úÖ Email deleted successfully', 'success');
                    } else {
                        showNotification('‚ùå Failed to delete email', 'error');
                    }
                })
                .catch(err => {
                    console.error('Error deleting email:', err);
                    showNotification('‚ùå Error deleting email', 'error');
                });
            }
        }

        function deleteAddress(address) {
            if (confirm(`Are you sure you want to delete ALL emails for ${address}?`)) {
                fetch(API_URL + '/api/admin/delete-address/' + encodeURIComponent(address), {
                    method: 'DELETE',
                    credentials: 'include'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        loadAddresses();
                        loadStats();
                        document.getElementById('email-details').innerHTML = '<p class="text-gray-400 text-center py-8">Select an email address to view emails</p>';
                        document.getElementById('selected-address').textContent = 'None selected';
                        document.getElementById('email-count-badge').classList.add('hidden');
                        showNotification('‚úÖ All emails deleted for ' + address, 'success');
                    } else {
                        showNotification('‚ùå Failed to delete emails', 'error');
                    }
                })
                .catch(err => {
                    console.error('Error deleting address:', err);
                    showNotification('‚ùå Error deleting emails', 'error');
                });
            }
        }

        function loadActiveSessions() {
            fetch(API_URL + '/api/admin/sessions', {credentials: 'include'})
                .then(res => res.json())
                .then(data => {
                    const sessionsEl = document.getElementById('active-sessions');
                    
                    if (!data || data.error || !data.sessions || data.sessions.length === 0) {
                        sessionsEl.innerHTML = '<p class="text-gray-400 text-center py-8">No active sessions</p>';
                        return;
                    }
                    
                    sessionsEl.innerHTML = '';
                    data.sessions.forEach(session => {
                        const item = document.createElement('div');
                        item.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-gray-600 transition-colors';
                        item.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-white font-semibold text-sm truncate">${escapeHtml(session.email)}</p>
                                    <p class="text-xs text-gray-400 mt-2">
                                        Created: ${formatTime(session.created_at)} ‚Ä¢ 
                                        Expires: ${formatTime(session.expires_at)}
                                    </p>
                                </div>
                                <button onclick="endUserSession('${session.session_token}', '${escapeHtml(session.email)}')" class="text-red-400 hover:text-red-300 p-2 rounded transition-colors ml-2" title="End Session">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            </div>
                        `;
                        sessionsEl.appendChild(item);
                    });
                })
                .catch(err => {
                    console.error('Error loading sessions:', err);
                    document.getElementById('active-sessions').innerHTML = '<p class="text-red-400 text-center py-8">Failed to load sessions</p>';
                });
        }

        function endUserSession(sessionToken, email) {
            if (confirm(`End session for ${email}?`)) {
                fetch(API_URL + '/api/admin/session/' + sessionToken + '/end', {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`‚úÖ Session ended for ${email}`, 'success');
                        loadActiveSessions();
                    } else {
                        showNotification(`‚ùå Failed to end session`, 'error');
                    }
                })
                .catch(err => {
                    console.error('Error ending session:', err);
                    showNotification('‚ùå Error ending session', 'error');
                });
            }
        }

        function loadBlacklist() {
            fetch(API_URL + '/api/admin/blacklist', {credentials: 'include'})
                .then(res => res.json())
                .then(data => {
                    const blacklistEl = document.getElementById('blacklist-list');
                    
                    if (!data || data.error || !data.blacklist || data.blacklist.length === 0) {
                        blacklistEl.innerHTML = '<p class="text-gray-400 text-center py-8">No blacklisted usernames</p>';
                        return;
                    }
                    
                    blacklistEl.innerHTML = '';
                    data.blacklist.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'bg-gray-800 p-3 rounded-lg border border-gray-700 flex justify-between items-center';
                        itemDiv.innerHTML = `
                            <div>
                                <span class="text-white font-semibold text-sm">${escapeHtml(item.username)}</span>
                                <span class="text-xs text-gray-400 ml-2">Added by ${item.added_by}</span>
                            </div>
                            <button onclick="removeFromBlacklist('${escapeHtml(item.username)}')" class="text-green-400 hover:text-green-300 p-1 rounded transition-colors" title="Remove from blacklist">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        blacklistEl.appendChild(itemDiv);
                    });
                })
                .catch(err => {
                    console.error('Error loading blacklist:', err);
                    document.getElementById('blacklist-list').innerHTML = '<p class="text-red-400 text-center py-8">Failed to load blacklist</p>';
                });
        }

        function addToBlacklist() {
            const usernameInput = document.getElementById('new-blacklist-username');
            const username = usernameInput.value.trim().toLowerCase();
            
            if (!username) {
                showNotification('‚ùå Please enter a username', 'error');
                return;
            }
            
            if (!/^[a-zA-Z0-9-_]+$/.test(username)) {
                showNotification('‚ùå Username can only contain letters, numbers, hyphens, and underscores', 'error');
                return;
            }
            
            fetch(API_URL + '/api/admin/blacklist', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({username: username})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showNotification(`‚úÖ ${data.message}`, 'success');
                    usernameInput.value = '';
                    loadBlacklist();
                } else {
                    showNotification(`‚ùå ${data.error || 'Failed to add to blacklist'}`, 'error');
                }
            })
            .catch(err => {
                console.error('Error adding to blacklist:', err);
                showNotification('‚ùå Error adding to blacklist', 'error');
            });
        }

        function removeFromBlacklist(username) {
            if (confirm(`Remove ${username} from blacklist?`)) {
                fetch(API_URL + '/api/admin/blacklist/' + encodeURIComponent(username), {
                    method: 'DELETE',
                    credentials: 'include'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`‚úÖ ${data.message}`, 'success');
                        loadBlacklist();
                    } else {
                        showNotification(`‚ùå ${data.error || 'Failed to remove from blacklist'}`, 'error');
                    }
                })
                .catch(err => {
                    console.error('Error removing from blacklist:', err);
                    showNotification('‚ùå Error removing from blacklist', 'error');
                });
            }
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                loadStats();
                loadAddresses();
                loadActiveSessions();
                loadBlacklist();
                if (selectedAddress) viewEmails(selectedAddress);
            }, 10000);
        }

        // Utility functions
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'never';
            try {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                
                if (minutes < 1) return 'just now';
                if (minutes < 60) return minutes + ' min ago';
                if (hours < 24) return hours + ' hour ago';
                if (days < 7) return days + ' day ago';
                
                return date.toLocaleDateString();
            } catch (e) {
                return 'unknown';
            }
        }

        function showNotification(message, type) {
            // Simple notification implementation
            alert(`${type === 'success' ? '‚úÖ' : '‚ùå'} ${message}`);
        }
    </script>
</body>
</html>
