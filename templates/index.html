<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TempMail - AMMZ</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📧</text></svg>">
<style>
body {
font-family: 'Inter', sans-serif;
background: linear-gradient(135deg, #1e3a8a 0%, #7e22ce 100%);
min-height: 100vh;
}
.glass-effect {
background: rgba(255, 255, 255, 0.15);
backdrop-filter: blur(12px);
border: 1px solid rgba(255, 255, 255, 0.2);
}
.email-item {
transition: all 0.2s ease;
cursor: pointer;
}
.email-item:hover {
background: rgba(255, 255, 255, 0.2);
transform: translateY(-1px);
}
.email-item.active {
background: rgba(168, 85, 247, 0.3);
}
#loader {
border: 3px solid rgba(255, 255, 255, 0.3);
border-top: 3px solid #fff;
border-radius: 50%;
width: 25px;
height: 25px;
animation: spin 1s linear infinite;
}
@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
.fade-in {
animation: fadeIn 0.5s ease-in;
}
@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}

/* Improved responsive inbox styles */
.mobile-inbox-container {
flex-direction: column;
height: auto;
}
.mobile-inbox-list {
height: 400px;
max-height: 400px;
min-height: 300px;
}
.mobile-email-content {
height: 500px;
max-height: 500px;
min-height: 400px;
}

@media (min-width: 768px) {
.mobile-inbox-container {
flex-direction: row;
height: 600px;
}
.mobile-inbox-list {
height: 100%;
max-height: none;
min-height: auto;
}
.mobile-email-content {
height: 100%;
max-height: none;
min-height: auto;
}
}

#email-content-container {
height: 100%;
overflow: hidden;
}
#email-body {
height: calc(100% - 120px);
overflow-y: auto;
overflow-x: hidden;
}
#email-body * {
max-width: 100%;
word-wrap: break-word;
}

/* Improved email content styling */
.email-content-container {
background: rgba(255, 255, 255, 0.05);
border-radius: 12px;
padding: 16px;
overflow-y: auto;
height: 100%;
}
.email-content-text {
line-height: 1.6;
font-size: 14px;
color: #e5e7eb;
}
.email-content-text p {
margin-bottom: 1rem;
}
.email-content-text code {
background: rgba(255, 255, 255, 0.1);
padding: 2px 6px;
border-radius: 4px;
font-family: monospace;
}
.email-content-text pre {
background: rgba(0, 0, 0, 0.3);
padding: 12px;
border-radius: 6px;
overflow-x: auto;
margin: 1rem 0;
}
.email-content-text a {
color: #60a5fa;
text-decoration: underline;
}
.email-content-text ul, .email-content-text ol {
padding-left: 1.5rem;
margin-bottom: 1rem;
}
.email-content-text li {
margin-bottom: 0.5rem;
}
.email-content-text h1, .email-content-text h2, .email-content-text h3 {
color: white;
margin-top: 1.5rem;
margin-bottom: 0.75rem;
}
.email-content-text h1 {
font-size: 1.5rem;
}
.email-content-text h2 {
font-size: 1.3rem;
}
.email-content-text h3 {
font-size: 1.1rem;
}
.email-content-text blockquote {
border-left: 4px solid rgba(255, 255, 255, 0.3);
padding-left: 1rem;
margin: 1rem 0;
font-style: italic;
}
.verification-code {
background: linear-gradient(135deg, #10b981 0%, #059669 100%);
color: white;
font-size: 1.5rem;
font-weight: bold;
padding: 15px;
border-radius: 8px;
text-align: center;
margin: 20px 0;
letter-spacing: 5px;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
.email-header {
background: rgba(0, 0, 0, 0.2);
padding: 12px;
border-radius: 8px;
margin-bottom: 15px;
}
.email-meta {
background: rgba(0, 0, 0, 0.1);
padding: 10px;
border-radius: 6px;
margin-bottom: 15px;
font-size: 12px;
color: #9ca3af;
}

/* Improved inbox list styling */
#email-list-container {
height: calc(100% - 60px);
overflow-y: auto;
}
.email-list-item {
padding: 12px;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
transition: all 0.2s ease;
cursor: pointer;
}
.email-list-item:hover {
background: rgba(255, 255, 255, 0.1);
}
.email-list-item.active {
background: rgba(168, 85, 247, 0.3);
}
.email-preview {
display: -webkit-box;
-webkit-line-clamp: 2;
-webkit-box-orient: vertical;
overflow: hidden;
}
</style>
</head>
<body class="text-gray-100 min-h-screen p-2 md:p-4">

<div class="h-fit mb-2">
<div class="bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 text-white py-2 px-4 rounded-lg shadow-lg">
<marquee class="text-sm md:text-base font-medium">
✨ This website was created by <b class="text-yellow-300">Aung Myo Myat Zaw </b>✨
</marquee>
</div>
</div>

<div class="w-full max-w-6xl mx-auto">
<header class="text-center mb-4 md:mb-8 fade-in">
<div class="flex items-center justify-center mb-2 md:mb-4">
<i class="fas fa-envelope text-xl md:text-3xl text-white mr-2 md:mr-3"></i>
<h1 class="text-xl md:text-4xl lg:text-5xl font-bold text-white">Secure Temp Mail By AMMZ</h1>
</div>
<p class="text-gray-300 text-sm md:text-lg font-medium">Disposable email addresses</p>
</header>

<main class="glass-effect rounded-2xl shadow-2xl p-3 md:p-6 lg:p-8 w-full fade-in">
<div class="mb-4 md:mb-8 text-center">
<button id="big-random-btn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 md:py-4 px-6 md:px-8 rounded-2xl transition-all transform hover:scale-105 shadow-lg text-base md:text-xl w-full max-w-md mx-auto flex items-center justify-center">
<i class="fas fa-random mr-2 md:mr-3 text-lg md:text-xl"></i>
Generate Random Email
</button>
<p class="text-gray-300 text-xs md:text-sm mt-2 font-medium">One click to create a random email instantly</p>
</div>

<div class="mb-4 md:mb-8">
<div class="flex flex-col gap-2 mb-3 md:mb-6">
<div class="flex flex-col sm:flex-row gap-2 w-full">
<div class="flex-1">
<input type="text" id="username-input" placeholder="Enter username"
class="w-full h-12 md:h-14 bg-gray-900 border-2 border-gray-700 text-white rounded-xl px-4 py-3 text-base md:text-lg focus:outline-none focus:border-blue-500 transition-colors">
</div>
<div class="w-full sm:w-auto sm:min-w-[200px]">
<select id="domain-select" class="w-full h-12 md:h-14 bg-gray-900 border-2 border-gray-700 text-white rounded-xl px-4 py-3 text-base md:text-lg focus:outline-none focus:border-blue-500 transition-colors">
<option value="">Select domain</option>
</select>
</div>
</div>

<!-- Buttons row -->
<div class="flex gap-2 w-full">
<button id="create-btn" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg flex-1 text-base">
<i class="fas fa-plus mr-2"></i>Create
</button>
<button id="copy-btn" class="bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white font-semibold py-3 px-6 rounded-xl transition-all transform hover:scale-105 shadow-lg flex-1 text-base">
<i class="fas fa-copy mr-2"></i>Copy
</button>
</div>
</div>

<div id="email-display" class="hidden text-center p-2 md:p-4 bg-gray-900 rounded-xl mb-2 md:mb-4 border border-gray-700">
<div class="flex items-center justify-center">
<i class="fas fa-envelope text-blue-400 mr-2 text-sm md:text-xl"></i>
<span id="current-email" class="text-white font-mono text-xs md:text-lg font-semibold break-all"></span>
</div>
</div>
</div>

<div id="notification" class="hidden text-center mb-2 md:mb-4 p-2 md:p-4 rounded-xl text-white font-medium text-sm md:text-base">
<i class="fas fa-check-circle mr-2"></i>
<span id="notification-text"></span>
</div>

<!-- Improved Inbox Section -->
<div class="flex flex-col md:flex-row gap-4 mobile-inbox-container">
<!-- Inbox List - Improved -->
<div class="w-full md:w-2/5 glass-effect rounded-xl p-3 md:p-4 mobile-inbox-list">
<div class="flex justify-between items-center mb-3">
<h2 class="text-lg md:text-xl font-semibold text-white flex items-center">
<i class="fas fa-inbox mr-2"></i>Inbox
</h2>
<div class="flex items-center gap-2">
<span id="email-count" class="text-xs text-gray-300 font-medium bg-gray-800 px-2 py-1 rounded">0 emails</span>
<button id="refresh-btn" class="p-2 rounded-lg hover:bg-gray-700 transition-colors text-white">
<i class="fas fa-sync-alt text-sm"></i>
</button>
</div>
</div>
<div id="email-list-container" class="h-full overflow-y-auto rounded-lg">
<div id="no-emails-default" class="text-center py-8 text-gray-300">
<i class="fas fa-envelope-open text-3xl mb-3 opacity-60"></i>
<p class="text-base font-medium">No emails yet</p>
<p class="text-sm mt-1 text-gray-400">Waiting for messages...</p>
</div>
<div id="inbox-loader" style="display:none;" class="flex justify-center items-center py-8">
<div id="loader"></div>
</div>
<div id="email-list" class="space-y-2"></div>
</div>
</div>

<!-- Email Content - Improved -->
<div class="w-full md:w-3/5 glass-effect rounded-xl p-4 mobile-email-content">
<div id="email-placeholder" class="flex flex-col items-center justify-center h-full text-gray-300 py-8">
<i class="fas fa-envelope-open text-4xl md:text-5xl mb-4 opacity-60"></i>
<p class="text-lg md:text-xl font-medium text-center">Select an email to read</p>
<p class="text-sm mt-2 text-gray-400 text-center">Choose a message from your inbox to view its contents</p>
</div>
<div id="email-content" class="hidden h-full flex flex-col">
<div class="flex flex-col md:flex-row justify-between items-start mb-4 gap-2">
<h2 id="email-subject" class="text-xl md:text-2xl font-bold text-white break-words flex-1"></h2>
<span id="email-date" class="text-xs text-gray-300 bg-gray-800 px-3 py-1 rounded-lg font-medium whitespace-nowrap"></span>
</div>
<div class="flex items-center text-sm text-gray-300 mb-4 border-b border-gray-700 pb-3">
<strong class="mr-2 text-white font-semibold flex items-center">
<i class="fas fa-user mr-2"></i>From:
</strong>
<span id="email-from" class="font-mono font-medium break-all"></span>
</div>
<div id="email-body" class="email-content-container email-content-text flex-1"></div>
</div>
</div>
</div>
</main>
</div>

<div class="h-fit mt-2 md:mt-4">
<div class="bg-gradient-to-r from-green-600 via-teal-600 to-blue-600 text-white py-2 px-4 rounded-lg shadow-lg border border-green-400">
<marquee class="text-xs md:text-base font-medium">
🔒 Secure & Private • All Rights Reserved by <b class="text-yellow-300">AMMZ</b> • Built with Advanced AI Technology 🚀
</marquee>
</div>
</div>

<script>
var API_URL = window.location.origin;
var currentEmail = '';
var autoRefreshInterval = null;
var timeUpdateInterval = null;
var lastEmailCount = 0;
var sessionId = generateSessionId();
var emailSecurityKey = generateSecurityKey();
var sessionStartTime = null;
var domainsLoaded = false;

// Generate a unique session ID for security
function generateSessionId() {
    return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
}

// Generate a security key for email requests
function generateSecurityKey() {
    return 'key_' + Math.random().toString(36).substr(2, 16);
}

// Load session from localStorage
function loadSession() {
    const savedSession = localStorage.getItem('tempMailSession');
    if (savedSession) {
        const session = JSON.parse(savedSession);
        const now = Date.now();
        const sessionAge = now - session.createdAt;
        
        // Session expires after 1 hour OR if no emails received for 1 hour
        const hasRecentEmail = session.lastEmailTime && (now - session.lastEmailTime < 60 * 60 * 1000);
        const sessionValid = sessionAge < 60 * 60 * 1000 && hasRecentEmail;
        
        if (sessionValid && session.email) {
            currentEmail = session.email;
            sessionStartTime = session.createdAt;
            
            // Wait for domains to load before restoring
            if (domainsLoaded) {
                restoreSessionUI();
            } else {
                // If domains aren't loaded yet, wait for them
                const checkDomains = setInterval(() => {
                    if (domainsLoaded) {
                        clearInterval(checkDomains);
                        restoreSessionUI();
                    }
                }, 100);
            }
            return true;
        } else {
            // Session expired
            localStorage.removeItem('tempMailSession');
            showNotification('🕒 Session expired', 'error');
        }
    }
    return false;
}

// Restore the session UI
function restoreSessionUI() {
    if (!currentEmail) return;
    
    var parts = currentEmail.split('@');
    document.getElementById('username-input').value = parts[0];
    document.getElementById('domain-select').value = parts[1];
    
    // Show the email display immediately
    document.getElementById('current-email').textContent = currentEmail;
    document.getElementById('email-display').classList.remove('hidden');
    
    showNotification('✅ Session restored', 'success');
    
    // Load emails immediately
    loadEmails();
    startAutoRefresh();
    startTimeUpdate();
    setupSessionExpiration();
}

// Save session to localStorage
function saveSession() {
    if (!currentEmail) return;
    
    const session = {
        email: currentEmail,
        createdAt: sessionStartTime || Date.now(),
        lastEmailTime: Date.now()
    };
    localStorage.setItem('tempMailSession', JSON.stringify(session));
}

// Update last email time in session
function updateLastEmailTime() {
    const savedSession = localStorage.getItem('tempMailSession');
    if (savedSession && currentEmail) {
        const session = JSON.parse(savedSession);
        session.lastEmailTime = Date.now();
        localStorage.setItem('tempMailSession', JSON.stringify(session));
    }
}

function loadDomains() {
    return fetch(API_URL + '/api/domains')
    .then(res => {
        if (!res.ok) {
            throw new Error('Failed to load domains');
        }
        return res.json();
    })
    .then(data => {
        var select = document.getElementById('domain-select');
        select.innerHTML = '<option value="">Select domain</option>';
        if (data.domains && data.domains.length > 0) {
            data.domains.forEach(function(d) {
                select.innerHTML += '<option value="' + d + '">' + d + '</option>';
            });
        } else {
            // Fallback domain
            select.innerHTML += '<option value="aungmyomyatzaw.online">aungmyomyatzaw.online</option>';
        }
        domainsLoaded = true;
    })
    .catch(err => {
        console.error('Error loading domains:', err);
        // Set default domain if API fails
        var select = document.getElementById('domain-select');
        select.innerHTML = '<option value="">Select domain</option>';
        select.innerHTML += '<option value="aungmyomyatzaw.online">aungmyomyatzaw.online</option>';
        domainsLoaded = true;
    });
}

document.getElementById('big-random-btn').addEventListener('click', function() {
    document.getElementById('username-input').value = '';
    createEmail('');
});

document.getElementById('create-btn').addEventListener('click', function() {
    var username = document.getElementById('username-input').value.trim();
    var domain = document.getElementById('domain-select').value;
    
    if (!username) {
        showNotification('❌ Please enter a username!', 'error');
        return;
    }
    
    if (!domain) {
        showNotification('❌ Please select a domain!', 'error');
        return;
    }
    
    createEmail(username);
});

function createEmail(customName) {
    var btn = document.getElementById('create-btn');
    var originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
    
    // Security: Include session ID and security key in request
    fetch(API_URL + '/api/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionId,
            'X-Security-Key': emailSecurityKey
        },
        body: JSON.stringify({
            name: customName,
            sessionId: sessionId
        })
    })
    .then(res => {
        if (!res.ok) {
            // If server error, try to parse the error message
            return res.text().then(text => {
                throw new Error(text || 'Server error: ' + res.status);
            });
        }
        return res.json();
    })
    .then(data => {
        if (!data.email) {
            throw new Error('No email returned from server');
        }
        
        currentEmail = data.email;
        sessionStartTime = Date.now();
        
        var parts = currentEmail.split('@');
        
        document.getElementById('username-input').value = parts[0];
        document.getElementById('domain-select').value = parts[1];
        document.getElementById('current-email').textContent = data.email;
        document.getElementById('email-display').classList.remove('hidden');
        
        // Reset email view to placeholder
        document.getElementById('email-placeholder').style.display = 'flex';
        document.getElementById('email-content').classList.add('hidden');
        
        showNotification('✅ Email created: ' + data.email, 'success');
        
        // Save session and start timers
        saveSession();
        
        // Wait a moment for the server to register the email, then load emails
        setTimeout(() => {
            loadEmails();
        }, 1000);
        
        startAutoRefresh();
        startTimeUpdate();
        setupSessionExpiration();
    })
    .catch(err => {
        console.error('Error creating email:', err);
        showNotification('❌ Error creating email: ' + err.message, 'error');
        
        // Fallback: Create email locally if API fails
        createEmailLocally(customName);
    })
    .finally(function() {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Fallback function to create email locally if API fails
function createEmailLocally(customName) {
    var domain = document.getElementById('domain-select').value;
    if (!domain) {
        domain = 'aungmyomyatzaw.online';
        document.getElementById('domain-select').value = domain;
    }
    
    var username = customName || generateRandomUsername();
    currentEmail = username + '@' + domain;
    sessionStartTime = Date.now();
    
    document.getElementById('username-input').value = username;
    document.getElementById('domain-select').value = domain;
    document.getElementById('current-email').textContent = currentEmail;
    document.getElementById('email-display').classList.remove('hidden');
    
    showNotification('✅ Email created locally: ' + currentEmail, 'success');
    
    // Save session and start timers
    saveSession();
    
    // Try to load emails anyway (might work if email exists on server)
    loadEmails();
    startAutoRefresh();
    startTimeUpdate();
    setupSessionExpiration();
}

function generateRandomUsername() {
    return Math.random().toString(36).substring(2, 12);
}

document.getElementById('copy-btn').addEventListener('click', function() {
    if (!currentEmail) {
        showNotification('❌ Create an email first!', 'error');
        return;
    }
    
    navigator.clipboard.writeText(currentEmail).then(function() {
        showNotification('📋 Copied: ' + currentEmail, 'success');
    }).catch(function() {
        // Fallback for older browsers
        var textArea = document.createElement("textarea");
        textArea.value = currentEmail;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);
        showNotification('📋 Copied: ' + currentEmail, 'success');
    });
});

document.getElementById('refresh-btn').addEventListener('click', loadEmails);

function loadEmails() {
    if (!currentEmail) {
        console.log('No current email to load');
        return;
    }
    
    console.log('Loading emails for:', currentEmail);
    
    var loader = document.getElementById('inbox-loader');
    var list = document.getElementById('email-list');
    var defaultMsg = document.getElementById('no-emails-default');
    
    loader.style.display = 'flex';
    defaultMsg.style.display = 'none';
    list.innerHTML = '';
    
    // Security: Include session ID and security key in request
    fetch(API_URL + '/api/emails/' + encodeURIComponent(currentEmail), {
        headers: {
            'X-Session-ID': sessionId,
            'X-Security-Key': emailSecurityKey
        }
    })
    .then(res => {
        if (!res.ok) {
            if (res.status === 404) {
                // Email doesn't exist yet, that's fine
                console.log('Email not found on server (404)');
                return { emails: [] };
            }
            return res.text().then(text => {
                throw new Error(text || 'Failed to fetch emails: ' + res.status);
            });
        }
        return res.json();
    })
    .then(data => {
        console.log('Emails loaded:', data);
        
        var newCount = data.emails ? data.emails.length : 0;
        document.getElementById('email-count').textContent = newCount + ' email' + (newCount !== 1 ? 's' : '');
        document.title = newCount > 0 ? '(' + newCount + ') TempMail - AMMZ' : 'TempMail - AMMZ';
        
        if (newCount > lastEmailCount && lastEmailCount > 0) {
            showNotification('🔔 ' + (newCount - lastEmailCount) + ' new email(s) received!', 'success');
            updateLastEmailTime();
        }
        lastEmailCount = newCount;
        
        list.innerHTML = '';
        
        if (newCount === 0) {
            list.innerHTML = '<div class="text-center py-8 text-gray-300"><i class="fas fa-envelope-open text-3xl mb-3 opacity-60"></i><p class="text-base font-medium">No emails yet</p><p class="text-sm mt-1 text-gray-400">Waiting for messages...</p></div>';
        } else {
            data.emails.forEach(function(email, idx) {
                var displaySender = email.sender;
                if (displaySender.includes('bounces+') || displaySender.includes('bounce-md')) {
                    displaySender = 'ChatGPT';
                } else if (displaySender.includes('<')) {
                    displaySender = displaySender.substring(0, displaySender.indexOf('<')).trim() || displaySender.substring(displaySender.indexOf('<')+1, displaySender.indexOf('>')).trim();
                }
                
                // Extract clean preview text
                var previewText = extractTextFromHTML(email.body);
                if (previewText.length > 80) {
                    previewText = previewText.substring(0, 80) + '...';
                }
                
                var item = document.createElement('div');
                item.className = 'email-list-item rounded-lg border border-gray-700 hover:border-gray-600 transition-all';
                item.setAttribute('data-timestamp', email.timestamp);
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-sm font-semibold text-white truncate flex-1 mr-2">${escapeHtml(displaySender)}</span>
                        <span class="text-xs text-gray-400 email-time whitespace-nowrap">${formatTime(email.timestamp)}</span>
                    </div>
                    <div class="text-sm font-medium text-gray-200 mb-2 truncate">${escapeHtml(email.subject)}</div>
                    <div class="text-xs text-gray-400 email-preview">${escapeHtml(previewText)}</div>
                `;
                item.addEventListener('click', function() { viewEmail(email, item); });
                list.appendChild(item);
            });
        }
    })
    .catch(err => {
        console.error('Error loading emails:', err);
        
        // Don't show error for 404 - it just means no emails yet
        if (!err.message.includes('404')) {
            showNotification('⚠️ Could not load emails: ' + err.message, 'error');
        }
        
        list.innerHTML = '<div class="text-center py-8 text-gray-300"><i class="fas fa-envelope-open text-3xl mb-3 opacity-60"></i><p class="text-base font-medium">No emails yet</p><p class="text-sm mt-1 text-gray-400">Waiting for messages...</p></div>';
    })
    .finally(function() {
        loader.style.display = 'none';
    });
}

// Update email times automatically
function updateEmailTimes() {
    const emailItems = document.querySelectorAll('.email-list-item');
    emailItems.forEach(item => {
        const timestamp = item.getAttribute('data-timestamp');
        const timeElement = item.querySelector('.email-time');
        if (timeElement && timestamp) {
            timeElement.textContent = formatTime(timestamp);
        }
    });
    
    // Also update the time in email content if an email is open
    const emailDateElement = document.getElementById('email-date');
    if (emailDateElement && emailDateElement.getAttribute('data-timestamp')) {
        emailDateElement.textContent = formatTime(emailDateElement.getAttribute('data-timestamp'));
    }
}

function viewEmail(email, itemEl) {
    document.querySelectorAll('.email-list-item').forEach(el => el.classList.remove('active'));
    itemEl.classList.add('active');
    
    document.getElementById('email-placeholder').style.display = 'none';
    document.getElementById('email-content').classList.remove('hidden');
    
    document.getElementById('email-subject').textContent = email.subject;
    document.getElementById('email-from').textContent = email.sender;
    document.getElementById('email-date').textContent = formatTime(email.timestamp);
    document.getElementById('email-date').setAttribute('data-timestamp', email.timestamp);
    
    var bodyEl = document.getElementById('email-body');
    
    // Process the email body to extract clean content
    var cleanBody = extractCleanEmailBody(email.body);
    bodyEl.innerHTML = cleanBody;
}

// Email body processing functions
function extractCleanEmailBody(rawBody) {
    try {
        // Simple cleanup - remove excessive whitespace
        let cleaned = rawBody.replace(/\s+/g, ' ').trim();
        
        // If it looks like HTML, sanitize it
        if (cleaned.includes('<') && cleaned.includes('>')) {
            return sanitizeHTML(cleaned);
        }
        
        // Otherwise format as plain text
        return formatTextContent(cleaned);
    } catch (e) {
        console.error('Error processing email body:', e);
        return '<p>' + escapeHtml(rawBody) + '</p>';
    }
}

function formatTextContent(text) {
    // Split into paragraphs and format
    var paragraphs = text.split(/\n\s*\n/);
    var html = '';
    
    for (var i = 0; i < paragraphs.length; i++) {
        var paragraph = paragraphs[i].trim();
        if (paragraph.length === 0) continue;
        html += '<p>' + escapeHtml(paragraph) + '</p>';
    }
    
    return html || '<p>No readable content found in this email.</p>';
}

function sanitizeHTML(html) {
    var temp = document.createElement('div');
    temp.innerHTML = html;
    
    // Remove potentially dangerous tags
    var dangerousTags = ['script', 'iframe', 'object', 'embed', 'link', 'meta', 'form', 'input', 'button'];
    dangerousTags.forEach(tag => {
        var elements = temp.querySelectorAll(tag);
        elements.forEach(el => el.remove());
    });
    
    // Remove dangerous attributes
    var allElements = temp.querySelectorAll('*');
    allElements.forEach(el => {
        var attributes = el.attributes;
        for (var i = attributes.length - 1; i >= 0; i--) {
            var attr = attributes[i];
            if (attr.name.startsWith('on') || 
                attr.name === 'href' && attr.value.startsWith('javascript:') ||
                attr.name === 'src' && attr.value.startsWith('javascript:')) {
                el.removeAttribute(attr.name);
            }
        }
    });
    
    return temp.innerHTML;
}

function extractTextFromHTML(html) {
    var temp = document.createElement('div');
    temp.innerHTML = html;
    var scripts = temp.querySelectorAll('script, style, link, meta');
    scripts.forEach(el => el.remove());
    var text = temp.textContent || temp.innerText || '';
    return text.replace(/\s+/g, ' ').trim();
}

function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshInterval = setInterval(loadEmails, 5000); // Refresh every 5 seconds
}

function startTimeUpdate() {
    if (timeUpdateInterval) clearInterval(timeUpdateInterval);
    timeUpdateInterval = setInterval(updateEmailTimes, 1000); // Update times every second
}

function showNotification(message, type) {
    var notif = document.getElementById('notification');
    var text = document.getElementById('notification-text');
    text.textContent = message;
    notif.className = type === 'success' ? 
        'text-center mb-2 md:mb-4 p-2 md:p-4 rounded-xl text-white font-medium text-sm md:text-base bg-green-600' :
        'text-center mb-2 md:mb-4 p-2 md:p-4 rounded-xl text-white font-medium text-sm md:text-base bg-red-600';
    notif.classList.remove('hidden');
    setTimeout(() => notif.classList.add('hidden'), 3000);
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Fixed time formatting function - NO PLURAL "s"
function formatTime(timestamp) {
    var date = new Date(timestamp);
    var now = new Date();
    var diff = now - date;
    var seconds = Math.floor(diff / 1000);
    var minutes = Math.floor(seconds / 60);
    var hours = Math.floor(minutes / 60);
    var days = Math.floor(hours / 24);
    
    if (seconds < 10) return 'just now';
    if (seconds < 60) return seconds + ' sec ago';
    if (minutes < 60) return minutes + ' min ago';
    if (hours < 24) return hours + ' hour ago';
    if (days < 7) return days + ' day ago';
    
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
}

// Add session expiration
function setupSessionExpiration() {
    var sessionTimeout = 60 * 60 * 1000; // 1 hour in milliseconds
    
    setTimeout(function() {
        showNotification('🕒 Session expired. Please create a new email address.', 'error');
        currentEmail = '';
        document.getElementById('email-display').classList.add('hidden');
        document.getElementById('email-placeholder').style.display = 'flex';
        document.getElementById('email-content').classList.add('hidden');
        document.getElementById('email-list').innerHTML = '';
        document.getElementById('email-count').textContent = '0 emails';
        document.title = 'TempMail - AMMZ';
        
        localStorage.removeItem('tempMailSession');
        
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
        if (timeUpdateInterval) {
            clearInterval(timeUpdateInterval);
            timeUpdateInterval = null;
        }
    }, sessionTimeout);
}

// Initialize the app
function initApp() {
    loadDomains().then(() => {
        // Try to load existing session after domains are loaded
        if (!loadSession()) {
            console.log('No valid session found, starting fresh');
        }
    }).catch(err => {
        console.error('Error loading domains:', err);
        // Even if domains fail, try to load session
        if (!loadSession()) {
            console.log('No valid session found, starting fresh');
        }
    });
}

// Start the app
initApp();
</script>
</body>
</html>
